<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 11 Hierarchical models and reparameterization  | An Introduction to Bayesian Data Analysis for Cognitive Science</title>
  <meta name="description" content="An introduction to Bayesian data analysis for Cognitive Science." />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 11 Hierarchical models and reparameterization  | An Introduction to Bayesian Data Analysis for Cognitive Science" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://vasishth.github.io/Bayes_CogSci//images/temporarycover.jpg" />
  <meta property="og:description" content="An introduction to Bayesian data analysis for Cognitive Science." />
  <meta name="github-repo" content="https://github.com/vasishth/Bayes_CogSci" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 Hierarchical models and reparameterization  | An Introduction to Bayesian Data Analysis for Cognitive Science" />
  
  <meta name="twitter:description" content="An introduction to Bayesian data analysis for Cognitive Science." />
  <meta name="twitter:image" content="https://vasishth.github.io/Bayes_CogSci//images/temporarycover.jpg" />

<meta name="author" content="Bruno Nicenboim, Daniel Schad, and Shravan Vasishth" />


<meta name="date" content="2024-08-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch-introstan.html"/>
<link rel="next" href="ch-custom.html"/>
<script src="libs/jquery/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block/empty-anchor.js"></script>
<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>
<script>
// FOLD code from 
// https://github.com/bblodfon/rtemps/blob/master/docs/bookdown-lite/hide_code.html
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/toc.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Bayesian Data Analysis for Cognitive Science (DRAFT)</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-read-this-book-and-what-is-its-target-audience"><i class="fa fa-check"></i>Why read this book, and what is its target audience?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#developing-the-right-mindset-for-this-book"><i class="fa fa-check"></i>Developing the right mindset for this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-read-this-book"><i class="fa fa-check"></i>How to read this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#some-conventions-used-in-this-book"><i class="fa fa-check"></i>Some conventions used in this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#online-materials"><i class="fa fa-check"></i>Online materials</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#software-needed"><i class="fa fa-check"></i>Software needed</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgments"><i class="fa fa-check"></i>Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="about-the-authors.html"><a href="about-the-authors.html"><i class="fa fa-check"></i>About the Authors</a></li>
<li class="part"><span><b>I Foundational ideas</b></span></li>
<li class="chapter" data-level="1" data-path="ch-intro.html"><a href="ch-intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="ch-intro.html"><a href="ch-intro.html#introprob"><i class="fa fa-check"></i><b>1.1</b> Probability</a></li>
<li class="chapter" data-level="1.2" data-path="ch-intro.html"><a href="ch-intro.html#condprob"><i class="fa fa-check"></i><b>1.2</b>  Conditional probability</a></li>
<li class="chapter" data-level="1.3" data-path="ch-intro.html"><a href="ch-intro.html#the-law-of-total-probability"><i class="fa fa-check"></i><b>1.3</b> The  law of total probability</a></li>
<li class="chapter" data-level="1.4" data-path="ch-intro.html"><a href="ch-intro.html#sec-binomialcloze"><i class="fa fa-check"></i><b>1.4</b>  Discrete random variables: An example using the  binomial distribution</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="ch-intro.html"><a href="ch-intro.html#the-mean-and-variance-of-the-binomial-distribution"><i class="fa fa-check"></i><b>1.4.1</b> The mean and variance of the binomial distribution</a></li>
<li class="chapter" data-level="1.4.2" data-path="ch-intro.html"><a href="ch-intro.html#what-information-does-a-probability-distribution-provide"><i class="fa fa-check"></i><b>1.4.2</b> What information does a probability distribution provide?</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="ch-intro.html"><a href="ch-intro.html#continuous-random-variables-an-example-using-the-normal-distribution"><i class="fa fa-check"></i><b>1.5</b>  Continuous random variables: An example using the  normal distribution</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="ch-intro.html"><a href="ch-intro.html#an-important-distinction-probability-vs.-density-in-a-continuous-random-variable"><i class="fa fa-check"></i><b>1.5.1</b> An important distinction: probability vs. density in a continuous random variable</a></li>
<li class="chapter" data-level="1.5.2" data-path="ch-intro.html"><a href="ch-intro.html#truncating-a-normal-distribution"><i class="fa fa-check"></i><b>1.5.2</b> Truncating a normal distribution</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="ch-intro.html"><a href="ch-intro.html#bivariate-and-multivariate-distributions"><i class="fa fa-check"></i><b>1.6</b> Bivariate and multivariate distributions</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="ch-intro.html"><a href="ch-intro.html#example-1-discrete-bivariate-distributions"><i class="fa fa-check"></i><b>1.6.1</b> Example 1:  Discrete bivariate distributions</a></li>
<li class="chapter" data-level="1.6.2" data-path="ch-intro.html"><a href="ch-intro.html#sec-contbivar"><i class="fa fa-check"></i><b>1.6.2</b> Example 2:  Continuous bivariate distributions</a></li>
<li class="chapter" data-level="1.6.3" data-path="ch-intro.html"><a href="ch-intro.html#sec-generatebivariatedata"><i class="fa fa-check"></i><b>1.6.3</b> Generate  simulated bivariate  (multivariate) data</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="ch-intro.html"><a href="ch-intro.html#sec-marginal"><i class="fa fa-check"></i><b>1.7</b> An important concept: The  marginal likelihood  (integrating out a parameter)</a></li>
<li class="chapter" data-level="1.8" data-path="ch-intro.html"><a href="ch-intro.html#summary-of-useful-r-functions-relating-to-distributions"><i class="fa fa-check"></i><b>1.8</b> Summary of useful R functions relating to distributions</a></li>
<li class="chapter" data-level="1.9" data-path="ch-intro.html"><a href="ch-intro.html#summary"><i class="fa fa-check"></i><b>1.9</b> Summary</a></li>
<li class="chapter" data-level="1.10" data-path="ch-intro.html"><a href="ch-intro.html#further-reading"><i class="fa fa-check"></i><b>1.10</b> Further reading</a></li>
<li class="chapter" data-level="1.11" data-path="ch-intro.html"><a href="ch-intro.html#sec-Foundationsexercises"><i class="fa fa-check"></i><b>1.11</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ch-introBDA.html"><a href="ch-introBDA.html"><i class="fa fa-check"></i><b>2</b> Introduction to Bayesian data analysis</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ch-introBDA.html"><a href="ch-introBDA.html#bayes-rule"><i class="fa fa-check"></i><b>2.1</b>  Bayes’ rule</a></li>
<li class="chapter" data-level="2.2" data-path="ch-introBDA.html"><a href="ch-introBDA.html#sec-analytical"><i class="fa fa-check"></i><b>2.2</b> Deriving the  posterior using Bayes’ rule: An analytical example</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="ch-introBDA.html"><a href="ch-introBDA.html#choosing-a-likelihood"><i class="fa fa-check"></i><b>2.2.1</b> Choosing a  likelihood</a></li>
<li class="chapter" data-level="2.2.2" data-path="ch-introBDA.html"><a href="ch-introBDA.html#sec-choosepriortheta"><i class="fa fa-check"></i><b>2.2.2</b> Choosing a  prior for <span class="math inline">\(\theta\)</span></a></li>
<li class="chapter" data-level="2.2.3" data-path="ch-introBDA.html"><a href="ch-introBDA.html#using-bayes-rule-to-compute-the-posterior-pthetank"><i class="fa fa-check"></i><b>2.2.3</b> Using  Bayes’ rule to compute the  posterior <span class="math inline">\(p(\theta|n,k)\)</span></a></li>
<li class="chapter" data-level="2.2.4" data-path="ch-introBDA.html"><a href="ch-introBDA.html#summary-of-the-procedure"><i class="fa fa-check"></i><b>2.2.4</b> Summary of the procedure</a></li>
<li class="chapter" data-level="2.2.5" data-path="ch-introBDA.html"><a href="ch-introBDA.html#visualizing-the-prior-likelihood-and-posterior"><i class="fa fa-check"></i><b>2.2.5</b> Visualizing the prior, likelihood, and posterior</a></li>
<li class="chapter" data-level="2.2.6" data-path="ch-introBDA.html"><a href="ch-introBDA.html#the-posterior-distribution-is-a-compromise-between-the-prior-and-the-likelihood"><i class="fa fa-check"></i><b>2.2.6</b> The  posterior distribution is a compromise between the prior and the likelihood</a></li>
<li class="chapter" data-level="2.2.7" data-path="ch-introBDA.html"><a href="ch-introBDA.html#incremental-knowledge-gain-using-prior-knowledge"><i class="fa fa-check"></i><b>2.2.7</b> Incremental knowledge gain using prior knowledge</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="ch-introBDA.html"><a href="ch-introBDA.html#summary-1"><i class="fa fa-check"></i><b>2.3</b> Summary</a></li>
<li class="chapter" data-level="2.4" data-path="ch-introBDA.html"><a href="ch-introBDA.html#further-reading-1"><i class="fa fa-check"></i><b>2.4</b> Further reading</a></li>
<li class="chapter" data-level="2.5" data-path="ch-introBDA.html"><a href="ch-introBDA.html#sec-BDAexercises"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II Regression models with brms</b></span></li>
<li class="chapter" data-level="3" data-path="ch-compbda.html"><a href="ch-compbda.html"><i class="fa fa-check"></i><b>3</b> Computational Bayesian data analysis</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-sampling"><i class="fa fa-check"></i><b>3.1</b> Deriving the  posterior through  sampling</a></li>
<li class="chapter" data-level="3.2" data-path="ch-compbda.html"><a href="ch-compbda.html#bayesian-regression-models-using-stan-brms"><i class="fa fa-check"></i><b>3.2</b>  Bayesian Regression Models using Stan:  brms</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-simplenormal"><i class="fa fa-check"></i><b>3.2.1</b> A simple linear model: A single subject pressing a button repeatedly (a finger tapping task)</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-priorpred"><i class="fa fa-check"></i><b>3.3</b>  Prior predictive distribution</a></li>
<li class="chapter" data-level="3.4" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-sensitivity"><i class="fa fa-check"></i><b>3.4</b> The influence of priors:  sensitivity analysis</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="ch-compbda.html"><a href="ch-compbda.html#flat-uninformative-priors"><i class="fa fa-check"></i><b>3.4.1</b>  Flat, uninformative priors</a></li>
<li class="chapter" data-level="3.4.2" data-path="ch-compbda.html"><a href="ch-compbda.html#regularizing-priors"><i class="fa fa-check"></i><b>3.4.2</b>  Regularizing priors</a></li>
<li class="chapter" data-level="3.4.3" data-path="ch-compbda.html"><a href="ch-compbda.html#principled-priors"><i class="fa fa-check"></i><b>3.4.3</b>  Principled priors</a></li>
<li class="chapter" data-level="3.4.4" data-path="ch-compbda.html"><a href="ch-compbda.html#informative-priors"><i class="fa fa-check"></i><b>3.4.4</b>  Informative priors</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-revisit"><i class="fa fa-check"></i><b>3.5</b> Revisiting the button-pressing example with different priors</a></li>
<li class="chapter" data-level="3.6" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-ppd"><i class="fa fa-check"></i><b>3.6</b>  Posterior predictive distribution</a></li>
<li class="chapter" data-level="3.7" data-path="ch-compbda.html"><a href="ch-compbda.html#the-influence-of-the-likelihood"><i class="fa fa-check"></i><b>3.7</b> The influence of the likelihood</a>
<ul>
<li class="chapter" data-level="3.7.1" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-lnfirst"><i class="fa fa-check"></i><b>3.7.1</b> The  log-normal likelihood</a></li>
<li class="chapter" data-level="3.7.2" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-lognormal"><i class="fa fa-check"></i><b>3.7.2</b> Using a log-normal likelihood to fit data from a single subject pressing a button repeatedly</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="ch-compbda.html"><a href="ch-compbda.html#list-of-the-most-important-commands"><i class="fa fa-check"></i><b>3.8</b> List of the most important commands</a></li>
<li class="chapter" data-level="3.9" data-path="ch-compbda.html"><a href="ch-compbda.html#summary-2"><i class="fa fa-check"></i><b>3.9</b> Summary</a></li>
<li class="chapter" data-level="3.10" data-path="ch-compbda.html"><a href="ch-compbda.html#sec-ch3furtherreading"><i class="fa fa-check"></i><b>3.10</b> Further reading</a></li>
<li class="chapter" data-level="3.11" data-path="ch-compbda.html"><a href="ch-compbda.html#ex:compbda"><i class="fa fa-check"></i><b>3.11</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ch-reg.html"><a href="ch-reg.html"><i class="fa fa-check"></i><b>4</b> Bayesian regression models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ch-reg.html"><a href="ch-reg.html#sec-pupil"><i class="fa fa-check"></i><b>4.1</b> A first  linear regression: Does attentional load affect pupil size?</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ch-reg.html"><a href="ch-reg.html#likelihood-and-priors"><i class="fa fa-check"></i><b>4.1.1</b>  Likelihood and  priors</a></li>
<li class="chapter" data-level="4.1.2" data-path="ch-reg.html"><a href="ch-reg.html#the-brms-model"><i class="fa fa-check"></i><b>4.1.2</b> The  <code>brms</code> model</a></li>
<li class="chapter" data-level="4.1.3" data-path="ch-reg.html"><a href="ch-reg.html#how-to-communicate-the-results"><i class="fa fa-check"></i><b>4.1.3</b> How to communicate the results?</a></li>
<li class="chapter" data-level="4.1.4" data-path="ch-reg.html"><a href="ch-reg.html#sec-pupiladq"><i class="fa fa-check"></i><b>4.1.4</b> Descriptive adequacy</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="ch-reg.html"><a href="ch-reg.html#sec-trial"><i class="fa fa-check"></i><b>4.2</b>  Log-normal model: Does trial affect response times?</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ch-reg.html"><a href="ch-reg.html#likelihood-and-priors-for-the-log-normal-model"><i class="fa fa-check"></i><b>4.2.1</b> Likelihood and priors for the log-normal model</a></li>
<li class="chapter" data-level="4.2.2" data-path="ch-reg.html"><a href="ch-reg.html#the-brms-model-1"><i class="fa fa-check"></i><b>4.2.2</b> The  <code>brms</code> model</a></li>
<li class="chapter" data-level="4.2.3" data-path="ch-reg.html"><a href="ch-reg.html#how-to-communicate-the-results-1"><i class="fa fa-check"></i><b>4.2.3</b> How to communicate the results?</a></li>
<li class="chapter" data-level="4.2.4" data-path="ch-reg.html"><a href="ch-reg.html#descriptive-adequacy"><i class="fa fa-check"></i><b>4.2.4</b> Descriptive adequacy</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="ch-reg.html"><a href="ch-reg.html#sec-logistic"><i class="fa fa-check"></i><b>4.3</b>  Logistic regression: Does  set size affect  free recall?</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="ch-reg.html"><a href="ch-reg.html#the-likelihood-for-the-logistic-regression-model"><i class="fa fa-check"></i><b>4.3.1</b> The likelihood for the logistic regression model</a></li>
<li class="chapter" data-level="4.3.2" data-path="ch-reg.html"><a href="ch-reg.html#sec-priorslogisticregression"><i class="fa fa-check"></i><b>4.3.2</b> Priors for the logistic regression</a></li>
<li class="chapter" data-level="4.3.3" data-path="ch-reg.html"><a href="ch-reg.html#the-brms-model-2"><i class="fa fa-check"></i><b>4.3.3</b> The <code>brms</code> model</a></li>
<li class="chapter" data-level="4.3.4" data-path="ch-reg.html"><a href="ch-reg.html#sec-comlogis"><i class="fa fa-check"></i><b>4.3.4</b> How to communicate the results?</a></li>
<li class="chapter" data-level="4.3.5" data-path="ch-reg.html"><a href="ch-reg.html#descriptive-adequacy-1"><i class="fa fa-check"></i><b>4.3.5</b>  Descriptive adequacy</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="ch-reg.html"><a href="ch-reg.html#summary-3"><i class="fa fa-check"></i><b>4.4</b> Summary</a></li>
<li class="chapter" data-level="4.5" data-path="ch-reg.html"><a href="ch-reg.html#sec-ch4furtherreading"><i class="fa fa-check"></i><b>4.5</b> Further reading</a></li>
<li class="chapter" data-level="4.6" data-path="ch-reg.html"><a href="ch-reg.html#sec-LMexercises"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html"><i class="fa fa-check"></i><b>5</b> Bayesian hierarchical models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#exchangeability-and-hierarchical-models"><i class="fa fa-check"></i><b>5.1</b> Exchangeability and hierarchical models</a></li>
<li class="chapter" data-level="5.2" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-N400hierarchical"><i class="fa fa-check"></i><b>5.2</b> A hierarchical model with a normal likelihood: The N400 effect</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-Mcp"><i class="fa fa-check"></i><b>5.2.1</b>  Complete pooling model (<span class="math inline">\(M_{cp}\)</span>)</a></li>
<li class="chapter" data-level="5.2.2" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#no-pooling-model-m_np"><i class="fa fa-check"></i><b>5.2.2</b>  No pooling model (<span class="math inline">\(M_{np}\)</span>)</a></li>
<li class="chapter" data-level="5.2.3" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-uncorrelated"><i class="fa fa-check"></i><b>5.2.3</b>  Varying intercepts and  varying slopes model (<span class="math inline">\(M_{v}\)</span>)</a></li>
<li class="chapter" data-level="5.2.4" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-mcvivs"><i class="fa fa-check"></i><b>5.2.4</b> Correlated varying intercept varying slopes model (<span class="math inline">\(M_{h}\)</span>)</a></li>
<li class="chapter" data-level="5.2.5" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-sih"><i class="fa fa-check"></i><b>5.2.5</b> By-subjects and by-items correlated varying intercept varying slopes model (<span class="math inline">\(M_{sih}\)</span>)</a></li>
<li class="chapter" data-level="5.2.6" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-distrmodel"><i class="fa fa-check"></i><b>5.2.6</b> Beyond the maximal model–Distributional regression models</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-stroop"><i class="fa fa-check"></i><b>5.3</b> A  hierarchical log-normal model: The  Stroop effect</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#a-correlated-varying-intercept-varying-slopes-log-normal-model"><i class="fa fa-check"></i><b>5.3.1</b> A correlated varying intercept varying slopes  log-normal model</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#why-fitting-a-bayesian-hierarchical-model-is-worth-the-effort"><i class="fa fa-check"></i><b>5.4</b> Why fitting a Bayesian hierarchical model is worth the effort</a></li>
<li class="chapter" data-level="5.5" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#summary-4"><i class="fa fa-check"></i><b>5.5</b> Summary</a></li>
<li class="chapter" data-level="5.6" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#further-reading-2"><i class="fa fa-check"></i><b>5.6</b> Further reading</a></li>
<li class="chapter" data-level="5.7" data-path="ch-hierarchical.html"><a href="ch-hierarchical.html#sec-HLMexercises"><i class="fa fa-check"></i><b>5.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ch-priors.html"><a href="ch-priors.html"><i class="fa fa-check"></i><b>6</b> The Art and Science of  Prior Elicitation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ch-priors.html"><a href="ch-priors.html#sec-simpleexamplepriors"><i class="fa fa-check"></i><b>6.1</b> Eliciting priors from oneself for a self-paced reading study: A simple example</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="ch-priors.html"><a href="ch-priors.html#an-example-english-relative-clauses"><i class="fa fa-check"></i><b>6.1.1</b> An example: English  relative clauses</a></li>
<li class="chapter" data-level="6.1.2" data-path="ch-priors.html"><a href="ch-priors.html#eliciting-a-prior-for-the-intercept"><i class="fa fa-check"></i><b>6.1.2</b> Eliciting a prior for the intercept</a></li>
<li class="chapter" data-level="6.1.3" data-path="ch-priors.html"><a href="ch-priors.html#eliciting-a-prior-for-the-slope"><i class="fa fa-check"></i><b>6.1.3</b> Eliciting a prior for the slope</a></li>
<li class="chapter" data-level="6.1.4" data-path="ch-priors.html"><a href="ch-priors.html#sec-varcomppriors"><i class="fa fa-check"></i><b>6.1.4</b> Eliciting priors for the  variance components</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="ch-priors.html"><a href="ch-priors.html#eliciting-priors-from-experts"><i class="fa fa-check"></i><b>6.2</b>  Eliciting priors from experts</a></li>
<li class="chapter" data-level="6.3" data-path="ch-priors.html"><a href="ch-priors.html#deriving-priors-from-meta-analyses"><i class="fa fa-check"></i><b>6.3</b> Deriving priors from  meta-analyses</a></li>
<li class="chapter" data-level="6.4" data-path="ch-priors.html"><a href="ch-priors.html#using-previous-experiments-posteriors-as-priors-for-a-new-study"><i class="fa fa-check"></i><b>6.4</b> Using previous experiments’  posteriors as priors for a new study</a></li>
<li class="chapter" data-level="6.5" data-path="ch-priors.html"><a href="ch-priors.html#summary-5"><i class="fa fa-check"></i><b>6.5</b> Summary</a></li>
<li class="chapter" data-level="6.6" data-path="ch-priors.html"><a href="ch-priors.html#further-reading-3"><i class="fa fa-check"></i><b>6.6</b> Further reading</a></li>
<li class="chapter" data-level="6.7" data-path="ch-priors.html"><a href="ch-priors.html#sec-priorsexercises"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ch-workflow.html"><a href="ch-workflow.html"><i class="fa fa-check"></i><b>7</b> Workflow</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ch-workflow.html"><a href="ch-workflow.html#building-a-model"><i class="fa fa-check"></i><b>7.1</b>  Building a model</a></li>
<li class="chapter" data-level="7.2" data-path="ch-workflow.html"><a href="ch-workflow.html#principled-questions-to-ask-on-a-model"><i class="fa fa-check"></i><b>7.2</b> Principled questions to ask on a model</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ch-workflow.html"><a href="ch-workflow.html#checking-whether-assumptions-are-consistent-with-domain-expertise-prior-predictive-checks"><i class="fa fa-check"></i><b>7.2.1</b>  Checking whether assumptions are consistent with  domain expertise: Prior predictive checks</a></li>
<li class="chapter" data-level="7.2.2" data-path="ch-workflow.html"><a href="ch-workflow.html#testing-for-correct-posterior-approximations-checks-of-computational-faithfulness"><i class="fa fa-check"></i><b>7.2.2</b>  Testing for correct posterior approximations: Checks of computational faithfulness</a></li>
<li class="chapter" data-level="7.2.3" data-path="ch-workflow.html"><a href="ch-workflow.html#sensitivity-of-the-model"><i class="fa fa-check"></i><b>7.2.3</b>  Sensitivity of the model</a></li>
<li class="chapter" data-level="7.2.4" data-path="ch-workflow.html"><a href="ch-workflow.html#does-the-model-adequately-capture-the-dataposterior-predictive-checks"><i class="fa fa-check"></i><b>7.2.4</b>  Does the model adequately capture the data?–Posterior predictive checks</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ch-workflow.html"><a href="ch-workflow.html#further-reading-4"><i class="fa fa-check"></i><b>7.3</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ch-contr.html"><a href="ch-contr.html"><i class="fa fa-check"></i><b>8</b>  Contrast coding</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ch-contr.html"><a href="ch-contr.html#basic-concepts-illustrated-using-a-two-level-factor"><i class="fa fa-check"></i><b>8.1</b> Basic concepts illustrated using a two-level factor</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="ch-contr.html"><a href="ch-contr.html#treatmentcontrasts"><i class="fa fa-check"></i><b>8.1.1</b> Default contrast coding:  Treatment contrasts</a></li>
<li class="chapter" data-level="8.1.2" data-path="ch-contr.html"><a href="ch-contr.html#inverseMatrix"><i class="fa fa-check"></i><b>8.1.2</b> Defining comparisons</a></li>
<li class="chapter" data-level="8.1.3" data-path="ch-contr.html"><a href="ch-contr.html#effectcoding"><i class="fa fa-check"></i><b>8.1.3</b>  Sum contrasts</a></li>
<li class="chapter" data-level="8.1.4" data-path="ch-contr.html"><a href="ch-contr.html#sec-cellMeans"><i class="fa fa-check"></i><b>8.1.4</b>  Cell means parameterization and  posterior comparisons</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="ch-contr.html"><a href="ch-contr.html#the-hypothesis-matrix-illustrated-with-a-three-level-factor"><i class="fa fa-check"></i><b>8.2</b> The hypothesis matrix illustrated with a three-level factor</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="ch-contr.html"><a href="ch-contr.html#sumcontrasts"><i class="fa fa-check"></i><b>8.2.1</b>  Sum contrasts</a></li>
<li class="chapter" data-level="8.2.2" data-path="ch-contr.html"><a href="ch-contr.html#the-hypothesis-matrix"><i class="fa fa-check"></i><b>8.2.2</b> The  hypothesis matrix</a></li>
<li class="chapter" data-level="8.2.3" data-path="ch-contr.html"><a href="ch-contr.html#generating-contrasts-the-hypr-package"><i class="fa fa-check"></i><b>8.2.3</b> Generating contrasts: The  <code>hypr</code> package</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="ch-contr.html"><a href="ch-contr.html#sec-4levelFactor"><i class="fa fa-check"></i><b>8.3</b> Other types of contrasts: illustration with a factor of four levels</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="ch-contr.html"><a href="ch-contr.html#repeatedcontrasts"><i class="fa fa-check"></i><b>8.3.1</b>  Repeated contrasts</a></li>
<li class="chapter" data-level="8.3.2" data-path="ch-contr.html"><a href="ch-contr.html#helmertcontrasts"><i class="fa fa-check"></i><b>8.3.2</b>  Helmert contrasts</a></li>
<li class="chapter" data-level="8.3.3" data-path="ch-contr.html"><a href="ch-contr.html#contrasts-in-linear-regression-analysis-the-design-or-model-matrix"><i class="fa fa-check"></i><b>8.3.3</b> Contrasts in linear regression analysis: The design or  model matrix</a></li>
<li class="chapter" data-level="8.3.4" data-path="ch-contr.html"><a href="ch-contr.html#polynomialContrasts"><i class="fa fa-check"></i><b>8.3.4</b>  Polynomial contrasts</a></li>
<li class="chapter" data-level="8.3.5" data-path="ch-contr.html"><a href="ch-contr.html#an-alternative-to-contrasts-monotonic-effects"><i class="fa fa-check"></i><b>8.3.5</b> An alternative to contrasts:  Monotonic effects</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="ch-contr.html"><a href="ch-contr.html#nonOrthogonal"><i class="fa fa-check"></i><b>8.4</b> What makes a good set of contrasts?</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="ch-contr.html"><a href="ch-contr.html#centered-contrasts"><i class="fa fa-check"></i><b>8.4.1</b>  Centered contrasts</a></li>
<li class="chapter" data-level="8.4.2" data-path="ch-contr.html"><a href="ch-contr.html#orthogonal-contrasts"><i class="fa fa-check"></i><b>8.4.2</b>  Orthogonal contrasts</a></li>
<li class="chapter" data-level="8.4.3" data-path="ch-contr.html"><a href="ch-contr.html#the-role-of-the-intercept-in-non-centered-contrasts"><i class="fa fa-check"></i><b>8.4.3</b> The role of the  intercept in  non-centered contrasts</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="ch-contr.html"><a href="ch-contr.html#computing-condition-means-from-estimated-contrasts"><i class="fa fa-check"></i><b>8.5</b> Computing condition means from estimated contrasts</a></li>
<li class="chapter" data-level="8.6" data-path="ch-contr.html"><a href="ch-contr.html#summary-6"><i class="fa fa-check"></i><b>8.6</b> Summary</a></li>
<li class="chapter" data-level="8.7" data-path="ch-contr.html"><a href="ch-contr.html#further-reading-5"><i class="fa fa-check"></i><b>8.7</b> Further reading</a></li>
<li class="chapter" data-level="8.8" data-path="ch-contr.html"><a href="ch-contr.html#sec-Contrastsexercises"><i class="fa fa-check"></i><b>8.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html"><i class="fa fa-check"></i><b>9</b> Contrast coding for designs with two predictor variables</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#sec-MR-ANOVA"><i class="fa fa-check"></i><b>9.1</b> Contrast coding in a factorial  <span class="math inline">\(2 \times 2\)</span> design</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#nestedEffects"><i class="fa fa-check"></i><b>9.1.1</b>  Nested effects</a></li>
<li class="chapter" data-level="9.1.2" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#interactions-between-contrasts"><i class="fa fa-check"></i><b>9.1.2</b>  Interactions between contrasts</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#sec-contrast-covariate"><i class="fa fa-check"></i><b>9.2</b> One factor and one  covariate</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#estimating-a-group-difference-and-controlling-for-a-covariate"><i class="fa fa-check"></i><b>9.2.1</b> Estimating a  group difference and controlling for a covariate</a></li>
<li class="chapter" data-level="9.2.2" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#estimating-differences-in-slopes"><i class="fa fa-check"></i><b>9.2.2</b> Estimating differences in slopes</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#sec-interactions-NLM"><i class="fa fa-check"></i><b>9.3</b> Interactions in generalized linear models (with non-linear link functions) and non-linear models</a></li>
<li class="chapter" data-level="9.4" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#summary-7"><i class="fa fa-check"></i><b>9.4</b> Summary</a></li>
<li class="chapter" data-level="9.5" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#further-reading-6"><i class="fa fa-check"></i><b>9.5</b> Further reading</a></li>
<li class="chapter" data-level="9.6" data-path="ch-coding2x2.html"><a href="ch-coding2x2.html#sec-Contrasts2x2exercises"><i class="fa fa-check"></i><b>9.6</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Advanced models with Stan</b></span></li>
<li class="chapter" data-level="10" data-path="ch-introstan.html"><a href="ch-introstan.html"><i class="fa fa-check"></i><b>10</b> Introduction to the probabilistic programming language Stan</a>
<ul>
<li class="chapter" data-level="10.1" data-path="ch-introstan.html"><a href="ch-introstan.html#stan-syntax"><i class="fa fa-check"></i><b>10.1</b> Stan syntax</a></li>
<li class="chapter" data-level="10.2" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-firststan"><i class="fa fa-check"></i><b>10.2</b> A first simple example with Stan:  Normal likelihood</a></li>
<li class="chapter" data-level="10.3" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-clozestan"><i class="fa fa-check"></i><b>10.3</b> Another simple example:  Cloze probability with Stan with the  binomial likelihood</a></li>
<li class="chapter" data-level="10.4" data-path="ch-introstan.html"><a href="ch-introstan.html#regression-models-in-stan"><i class="fa fa-check"></i><b>10.4</b>  Regression models in Stan</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-pupilstan"><i class="fa fa-check"></i><b>10.4.1</b> A first  linear regression in Stan: Does attentional load affect  pupil size?</a></li>
<li class="chapter" data-level="10.4.2" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-interstan"><i class="fa fa-check"></i><b>10.4.2</b>  Interactions in Stan: Does attentional load interact with trial number affecting  pupil size?</a></li>
<li class="chapter" data-level="10.4.3" data-path="ch-introstan.html"><a href="ch-introstan.html#sec-logisticstan"><i class="fa fa-check"></i><b>10.4.3</b>  Logistic regression in Stan: Does set size and trial affect free recall?</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="ch-introstan.html"><a href="ch-introstan.html#summary-8"><i class="fa fa-check"></i><b>10.5</b> Summary</a></li>
<li class="chapter" data-level="10.6" data-path="ch-introstan.html"><a href="ch-introstan.html#further-reading-7"><i class="fa fa-check"></i><b>10.6</b> Further reading</a></li>
<li class="chapter" data-level="10.7" data-path="ch-introstan.html"><a href="ch-introstan.html#exercises"><i class="fa fa-check"></i><b>10.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ch-complexstan.html"><a href="ch-complexstan.html"><i class="fa fa-check"></i><b>11</b> Hierarchical models and reparameterization </a>
<ul>
<li class="chapter" data-level="11.1" data-path="ch-complexstan.html"><a href="ch-complexstan.html#sec-hierstan"><i class="fa fa-check"></i><b>11.1</b> Hierarchical models with Stan</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="ch-complexstan.html"><a href="ch-complexstan.html#varying-intercept-model-with-stan"><i class="fa fa-check"></i><b>11.1.1</b> Varying intercept model with Stan</a></li>
<li class="chapter" data-level="11.1.2" data-path="ch-complexstan.html"><a href="ch-complexstan.html#sec-uncorrstan"><i class="fa fa-check"></i><b>11.1.2</b> Uncorrelated  varying intercept and slopes model with Stan</a></li>
<li class="chapter" data-level="11.1.3" data-path="ch-complexstan.html"><a href="ch-complexstan.html#sec-corrstan"><i class="fa fa-check"></i><b>11.1.3</b>  Correlated varying intercept varying slopes model</a></li>
<li class="chapter" data-level="11.1.4" data-path="ch-complexstan.html"><a href="ch-complexstan.html#sec-crosscorrstan"><i class="fa fa-check"></i><b>11.1.4</b> By-subject and by-items correlated varying intercept varying slopes model</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="ch-complexstan.html"><a href="ch-complexstan.html#summary-9"><i class="fa fa-check"></i><b>11.2</b> Summary</a></li>
<li class="chapter" data-level="11.3" data-path="ch-complexstan.html"><a href="ch-complexstan.html#further-reading-8"><i class="fa fa-check"></i><b>11.3</b> Further reading</a></li>
<li class="chapter" data-level="11.4" data-path="ch-complexstan.html"><a href="ch-complexstan.html#exercises-1"><i class="fa fa-check"></i><b>11.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="ch-custom.html"><a href="ch-custom.html"><i class="fa fa-check"></i><b>12</b> Custom distributions in Stan</a>
<ul>
<li class="chapter" data-level="12.1" data-path="ch-custom.html"><a href="ch-custom.html#sec-change"><i class="fa fa-check"></i><b>12.1</b> A change of variables with the reciprocal normal distribution</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="ch-custom.html"><a href="ch-custom.html#scaling-a-probability-density-with-the-jacobian-adjustment"><i class="fa fa-check"></i><b>12.1.1</b> Scaling a probability density with the Jacobian adjustment</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="ch-custom.html"><a href="ch-custom.html#sec-validSBC"><i class="fa fa-check"></i><b>12.2</b>  Validation of a computed posterior distribution</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="ch-custom.html"><a href="ch-custom.html#the-simulation-based-calibration-procedure"><i class="fa fa-check"></i><b>12.2.1</b> The  simulation-based calibration procedure</a></li>
<li class="chapter" data-level="12.2.2" data-path="ch-custom.html"><a href="ch-custom.html#an-example-where-simulation-based-calibration-reveals-a-problem"><i class="fa fa-check"></i><b>12.2.2</b> An example where simulation-based calibration reveals a problem</a></li>
<li class="chapter" data-level="12.2.3" data-path="ch-custom.html"><a href="ch-custom.html#issues-with-and-limitations-of-simulation-based-calibration"><i class="fa fa-check"></i><b>12.2.3</b> Issues with and limitations of simulation-based calibration</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="ch-custom.html"><a href="ch-custom.html#another-custom-distribution-the-exponential-distribution-implemented-manually"><i class="fa fa-check"></i><b>12.3</b> Another  custom distribution: The exponential distribution  implemented manually</a></li>
<li class="chapter" data-level="12.4" data-path="ch-custom.html"><a href="ch-custom.html#summary-10"><i class="fa fa-check"></i><b>12.4</b> Summary</a></li>
<li class="chapter" data-level="12.5" data-path="ch-custom.html"><a href="ch-custom.html#further-reading-9"><i class="fa fa-check"></i><b>12.5</b> Further reading</a></li>
<li class="chapter" data-level="12.6" data-path="ch-custom.html"><a href="ch-custom.html#sec-customexercises"><i class="fa fa-check"></i><b>12.6</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>IV Evidence synthesis and measurements with error</b></span></li>
<li class="chapter" data-level="13" data-path="ch-remame.html"><a href="ch-remame.html"><i class="fa fa-check"></i><b>13</b>  Meta-analysis and  measurement error models</a>
<ul>
<li class="chapter" data-level="13.1" data-path="ch-remame.html"><a href="ch-remame.html#meta-analysis"><i class="fa fa-check"></i><b>13.1</b> Meta-analysis</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="ch-remame.html"><a href="ch-remame.html#a-meta-analysis-of-similarity-based-interference-in-sentence-comprehension"><i class="fa fa-check"></i><b>13.1.1</b> A meta-analysis of similarity-based interference in sentence comprehension</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="ch-remame.html"><a href="ch-remame.html#measurement-error-models"><i class="fa fa-check"></i><b>13.2</b>  Measurement-error models</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="ch-remame.html"><a href="ch-remame.html#accounting-for-measurement-error-in-individual-differences-in-working-memory-capacity-and-reading-fluency"><i class="fa fa-check"></i><b>13.2.1</b> Accounting for measurement error in individual differences in working memory capacity and reading fluency</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="ch-remame.html"><a href="ch-remame.html#summary-11"><i class="fa fa-check"></i><b>13.3</b> Summary</a></li>
<li class="chapter" data-level="13.4" data-path="ch-remame.html"><a href="ch-remame.html#further-reading-10"><i class="fa fa-check"></i><b>13.4</b> Further reading</a></li>
<li class="chapter" data-level="13.5" data-path="ch-remame.html"><a href="ch-remame.html#sec-REMAMEexercises"><i class="fa fa-check"></i><b>13.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>V Model comparison</b></span></li>
<li class="chapter" data-level="14" data-path="ch-comparison.html"><a href="ch-comparison.html"><i class="fa fa-check"></i><b>14</b> Introduction to model comparison</a>
<ul>
<li class="chapter" data-level="14.1" data-path="ch-comparison.html"><a href="ch-comparison.html#prior-predictive-vs.-posterior-predictive-model-comparison"><i class="fa fa-check"></i><b>14.1</b> Prior predictive vs. posterior predictive model comparison</a></li>
<li class="chapter" data-level="14.2" data-path="ch-comparison.html"><a href="ch-comparison.html#some-important-points-to-consider-when-comparing-models"><i class="fa fa-check"></i><b>14.2</b> Some important points to consider when comparing models</a></li>
<li class="chapter" data-level="14.3" data-path="ch-comparison.html"><a href="ch-comparison.html#further-reading-11"><i class="fa fa-check"></i><b>14.3</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="ch-bf.html"><a href="ch-bf.html"><i class="fa fa-check"></i><b>15</b> Bayes factors</a>
<ul>
<li class="chapter" data-level="15.1" data-path="ch-bf.html"><a href="ch-bf.html#hypothesis-testing-using-the-bayes-factor"><i class="fa fa-check"></i><b>15.1</b> Hypothesis testing using the Bayes factor</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="ch-bf.html"><a href="ch-bf.html#marginal-likelihood"><i class="fa fa-check"></i><b>15.1.1</b> Marginal likelihood</a></li>
<li class="chapter" data-level="15.1.2" data-path="ch-bf.html"><a href="ch-bf.html#bayes-factor"><i class="fa fa-check"></i><b>15.1.2</b> Bayes factor</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="ch-bf.html"><a href="ch-bf.html#sec-N400BF"><i class="fa fa-check"></i><b>15.2</b> Examining the N400 effect with Bayes factor</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="ch-bf.html"><a href="ch-bf.html#sensitivity-analysis-1"><i class="fa fa-check"></i><b>15.2.1</b> Sensitivity analysis</a></li>
<li class="chapter" data-level="15.2.2" data-path="ch-bf.html"><a href="ch-bf.html#sec-BFnonnested"><i class="fa fa-check"></i><b>15.2.2</b>  Non-nested models</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="ch-bf.html"><a href="ch-bf.html#the-influence-of-the-priors-on-bayes-factors-beyond-the-effect-of-interest"><i class="fa fa-check"></i><b>15.3</b> The influence of the priors on Bayes factors: beyond the effect of interest</a></li>
<li class="chapter" data-level="15.4" data-path="ch-bf.html"><a href="ch-bf.html#sec-stanBF"><i class="fa fa-check"></i><b>15.4</b>  Bayes factor in Stan</a></li>
<li class="chapter" data-level="15.5" data-path="ch-bf.html"><a href="ch-bf.html#bayes-factors-in-theory-and-in-practice"><i class="fa fa-check"></i><b>15.5</b> Bayes factors in theory and in practice</a>
<ul>
<li class="chapter" data-level="15.5.1" data-path="ch-bf.html"><a href="ch-bf.html#bayes-factors-in-theory-stability-and-accuracy"><i class="fa fa-check"></i><b>15.5.1</b> Bayes factors in theory: Stability and  accuracy</a></li>
<li class="chapter" data-level="15.5.2" data-path="ch-bf.html"><a href="ch-bf.html#sec-BFvar"><i class="fa fa-check"></i><b>15.5.2</b> Bayes factors in practice: Variability with the data</a></li>
<li class="chapter" data-level="15.5.3" data-path="ch-bf.html"><a href="ch-bf.html#sec-caution"><i class="fa fa-check"></i><b>15.5.3</b> A cautionary note about Bayes factors</a></li>
</ul></li>
<li class="chapter" data-level="15.6" data-path="ch-bf.html"><a href="ch-bf.html#sample-size-determination-using-bayes-factors"><i class="fa fa-check"></i><b>15.6</b> Sample size determination using Bayes factors</a></li>
<li class="chapter" data-level="15.7" data-path="ch-bf.html"><a href="ch-bf.html#summary-12"><i class="fa fa-check"></i><b>15.7</b> Summary</a></li>
<li class="chapter" data-level="15.8" data-path="ch-bf.html"><a href="ch-bf.html#further-reading-12"><i class="fa fa-check"></i><b>15.8</b> Further reading</a></li>
<li class="chapter" data-level="15.9" data-path="ch-bf.html"><a href="ch-bf.html#exercises-2"><i class="fa fa-check"></i><b>15.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="ch-cv.html"><a href="ch-cv.html"><i class="fa fa-check"></i><b>16</b> Cross-validation</a>
<ul>
<li class="chapter" data-level="16.1" data-path="ch-cv.html"><a href="ch-cv.html#the-expected-log-predictive-density-of-a-model"><i class="fa fa-check"></i><b>16.1</b> The expected log predictive density of a model</a></li>
<li class="chapter" data-level="16.2" data-path="ch-cv.html"><a href="ch-cv.html#k-fold-and-leave-one-out-cross-validation"><i class="fa fa-check"></i><b>16.2</b> K-fold and leave-one-out cross-validation</a></li>
<li class="chapter" data-level="16.3" data-path="ch-cv.html"><a href="ch-cv.html#testing-the-n400-effect-using-cross-validation"><i class="fa fa-check"></i><b>16.3</b> Testing the N400 effect using cross-validation</a>
<ul>
<li class="chapter" data-level="16.3.1" data-path="ch-cv.html"><a href="ch-cv.html#cross-validation-with-psis-loo"><i class="fa fa-check"></i><b>16.3.1</b> Cross-validation with PSIS-LOO</a></li>
<li class="chapter" data-level="16.3.2" data-path="ch-cv.html"><a href="ch-cv.html#cross-validation-with-k-fold"><i class="fa fa-check"></i><b>16.3.2</b> Cross-validation with K-fold</a></li>
<li class="chapter" data-level="16.3.3" data-path="ch-cv.html"><a href="ch-cv.html#leave-one-group-out-cross-validation"><i class="fa fa-check"></i><b>16.3.3</b> Leave-one-group-out cross-validation</a></li>
</ul></li>
<li class="chapter" data-level="16.4" data-path="ch-cv.html"><a href="ch-cv.html#sec-logcv"><i class="fa fa-check"></i><b>16.4</b>  Comparing different likelihoods with cross-validation</a></li>
<li class="chapter" data-level="16.5" data-path="ch-cv.html"><a href="ch-cv.html#sec-issuesCV"><i class="fa fa-check"></i><b>16.5</b> Issues with cross-validation</a></li>
<li class="chapter" data-level="16.6" data-path="ch-cv.html"><a href="ch-cv.html#cross-validation-in-stan"><i class="fa fa-check"></i><b>16.6</b> Cross-validation in Stan</a>
<ul>
<li class="chapter" data-level="16.6.1" data-path="ch-cv.html"><a href="ch-cv.html#psis-loo-cv-in-stan"><i class="fa fa-check"></i><b>16.6.1</b>  PSIS-LOO-CV in Stan</a></li>
</ul></li>
<li class="chapter" data-level="16.7" data-path="ch-cv.html"><a href="ch-cv.html#summary-13"><i class="fa fa-check"></i><b>16.7</b> Summary</a></li>
<li class="chapter" data-level="16.8" data-path="ch-cv.html"><a href="ch-cv.html#further-reading-13"><i class="fa fa-check"></i><b>16.8</b> Further reading</a></li>
<li class="chapter" data-level="16.9" data-path="ch-cv.html"><a href="ch-cv.html#exercises-3"><i class="fa fa-check"></i><b>16.9</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>VI Cognitive modeling with Stan</b></span></li>
<li class="chapter" data-level="17" data-path="ch-cogmod.html"><a href="ch-cogmod.html"><i class="fa fa-check"></i><b>17</b> Introduction to cognitive modeling</a>
<ul>
<li class="chapter" data-level="17.1" data-path="ch-cogmod.html"><a href="ch-cogmod.html#what-characterizes-a-computational-cognitive-model"><i class="fa fa-check"></i><b>17.1</b> What characterizes a computational cognitive model?</a></li>
<li class="chapter" data-level="17.2" data-path="ch-cogmod.html"><a href="ch-cogmod.html#some-advantages-of-taking-the-latent-variable-modeling-approach"><i class="fa fa-check"></i><b>17.2</b> Some advantages of taking the latent-variable modeling approach</a></li>
<li class="chapter" data-level="17.3" data-path="ch-cogmod.html"><a href="ch-cogmod.html#types-of-computational-cognitive-model"><i class="fa fa-check"></i><b>17.3</b> Types of computational cognitive model</a></li>
<li class="chapter" data-level="17.4" data-path="ch-cogmod.html"><a href="ch-cogmod.html#summary-14"><i class="fa fa-check"></i><b>17.4</b> Summary</a></li>
<li class="chapter" data-level="17.5" data-path="ch-cogmod.html"><a href="ch-cogmod.html#further-reading-14"><i class="fa fa-check"></i><b>17.5</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="ch-MPT.html"><a href="ch-MPT.html"><i class="fa fa-check"></i><b>18</b> Multinomial processing trees</a>
<ul>
<li class="chapter" data-level="18.1" data-path="ch-MPT.html"><a href="ch-MPT.html#modeling-multiple-categorical-responses"><i class="fa fa-check"></i><b>18.1</b> Modeling  multiple categorical responses</a>
<ul>
<li class="chapter" data-level="18.1.1" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-mult"><i class="fa fa-check"></i><b>18.1.1</b> A model for multiple responses using the multinomial likelihood</a></li>
<li class="chapter" data-level="18.1.2" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-cat"><i class="fa fa-check"></i><b>18.1.2</b> A model for multiple responses using the categorical distribution</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="ch-MPT.html"><a href="ch-MPT.html#modeling-picture-naming-abilities-in-aphasia-with-mpt-models"><i class="fa fa-check"></i><b>18.2</b> Modeling picture naming abilities in aphasia with MPT models</a>
<ul>
<li class="chapter" data-level="18.2.1" data-path="ch-MPT.html"><a href="ch-MPT.html#calculation-of-the-probabilities-in-the-mpt-branches"><i class="fa fa-check"></i><b>18.2.1</b> Calculation of the probabilities in the MPT branches</a></li>
<li class="chapter" data-level="18.2.2" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-mpt-data"><i class="fa fa-check"></i><b>18.2.2</b> A simple MPT model</a></li>
<li class="chapter" data-level="18.2.3" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-MPT-reg"><i class="fa fa-check"></i><b>18.2.3</b> An MPT model assuming by-item variability</a></li>
<li class="chapter" data-level="18.2.4" data-path="ch-MPT.html"><a href="ch-MPT.html#sec-MPT-h"><i class="fa fa-check"></i><b>18.2.4</b> A  hierarchical MPT</a></li>
</ul></li>
<li class="chapter" data-level="18.3" data-path="ch-MPT.html"><a href="ch-MPT.html#summary-15"><i class="fa fa-check"></i><b>18.3</b> Summary</a></li>
<li class="chapter" data-level="18.4" data-path="ch-MPT.html"><a href="ch-MPT.html#further-reading-15"><i class="fa fa-check"></i><b>18.4</b> Further reading</a></li>
<li class="chapter" data-level="18.5" data-path="ch-MPT.html"><a href="ch-MPT.html#exercises-4"><i class="fa fa-check"></i><b>18.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="ch-mixture.html"><a href="ch-mixture.html"><i class="fa fa-check"></i><b>19</b> Mixture models</a>
<ul>
<li class="chapter" data-level="19.1" data-path="ch-mixture.html"><a href="ch-mixture.html#a-mixture-model-of-the-speed-accuracy-trade-off-the-fast-guess-model-account"><i class="fa fa-check"></i><b>19.1</b> A mixture model of the speed-accuracy trade-off: The fast-guess model account</a>
<ul>
<li class="chapter" data-level="19.1.1" data-path="ch-mixture.html"><a href="ch-mixture.html#the-global-motion-detection-task"><i class="fa fa-check"></i><b>19.1.1</b> The global motion detection task</a></li>
<li class="chapter" data-level="19.1.2" data-path="ch-mixture.html"><a href="ch-mixture.html#sec-simplefastguess"><i class="fa fa-check"></i><b>19.1.2</b> A very simple implementation of the fast-guess model</a></li>
<li class="chapter" data-level="19.1.3" data-path="ch-mixture.html"><a href="ch-mixture.html#sec-multmix"><i class="fa fa-check"></i><b>19.1.3</b> A  multivariate implementation of the fast-guess model</a></li>
<li class="chapter" data-level="19.1.4" data-path="ch-mixture.html"><a href="ch-mixture.html#an-implementation-of-the-fast-guess-model-that-takes-instructions-into-account"><i class="fa fa-check"></i><b>19.1.4</b> An implementation of the fast-guess model that takes instructions into account</a></li>
<li class="chapter" data-level="19.1.5" data-path="ch-mixture.html"><a href="ch-mixture.html#sec-fastguessh"><i class="fa fa-check"></i><b>19.1.5</b> A  hierarchical implementation of the fast-guess model</a></li>
</ul></li>
<li class="chapter" data-level="19.2" data-path="ch-mixture.html"><a href="ch-mixture.html#summary-16"><i class="fa fa-check"></i><b>19.2</b> Summary</a></li>
<li class="chapter" data-level="19.3" data-path="ch-mixture.html"><a href="ch-mixture.html#further-reading-16"><i class="fa fa-check"></i><b>19.3</b> Further reading</a></li>
<li class="chapter" data-level="19.4" data-path="ch-mixture.html"><a href="ch-mixture.html#exercises-5"><i class="fa fa-check"></i><b>19.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html"><i class="fa fa-check"></i><b>20</b> A simple accumulator model to account for choice response time</a>
<ul>
<li class="chapter" data-level="20.1" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#modeling-a-lexical-decision-task"><i class="fa fa-check"></i><b>20.1</b> Modeling a lexical decision task</a>
<ul>
<li class="chapter" data-level="20.1.1" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#sec-acccoding"><i class="fa fa-check"></i><b>20.1.1</b> Modeling the lexical decision task with the log-normal race model</a></li>
<li class="chapter" data-level="20.1.2" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#sec-genaccum"><i class="fa fa-check"></i><b>20.1.2</b> A generative model for a race between accumulators</a></li>
<li class="chapter" data-level="20.1.3" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#fitting-the-log-normal-race-model"><i class="fa fa-check"></i><b>20.1.3</b> Fitting the log-normal race model</a></li>
<li class="chapter" data-level="20.1.4" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#sec-lognormalh"><i class="fa fa-check"></i><b>20.1.4</b> A hierarchical implementation of the log-normal race model</a></li>
<li class="chapter" data-level="20.1.5" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#sec-contaminant"><i class="fa fa-check"></i><b>20.1.5</b> Dealing with  contaminant responses</a></li>
</ul></li>
<li class="chapter" data-level="20.2" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#posterior-predictive-check-with-the-quantile-probability-plots"><i class="fa fa-check"></i><b>20.2</b> Posterior predictive check with the quantile probability plots</a></li>
<li class="chapter" data-level="20.3" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#summary-17"><i class="fa fa-check"></i><b>20.3</b> Summary</a></li>
<li class="chapter" data-level="20.4" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#further-reading-17"><i class="fa fa-check"></i><b>20.4</b> Further reading</a></li>
<li class="chapter" data-level="20.5" data-path="ch-lognormalrace.html"><a href="ch-lognormalrace.html#exercises-6"><i class="fa fa-check"></i><b>20.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="ch-closing.html"><a href="ch-closing.html"><i class="fa fa-check"></i><b>21</b> In closing</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="_blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">An Introduction to Bayesian Data Analysis for Cognitive Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch-complexstan" class="section level1 hasAnchor" number="11">
<h1><span class="header-section-number">Chapter 11</span> Hierarchical models and reparameterization <a href="ch-complexstan.html#ch-complexstan" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Now that we know how to fit simple regression models using Stan syntax, we can turn to more complex cases, such as the  hierarchical models that we fit in <code>brms</code> in chapter <a href="ch-hierarchical.html#ch-hierarchical">5</a>. Fitting such models in Stan allows us a great deal of flexibility. However, a price to be paid when using Stan is that we need to think about how exactly we code the model. In some cases, two pieces of computer code that are mathematically similar might behave very differently due to the computer’s limitations; in this chapter, we will learn some of the more common techniques needed to optimize the model’s behavior. In particular, we will learn how to deal with convergence problems using what is called the  non-centered reparameterization.</p>
<div id="sec-hierstan" class="section level2 hasAnchor" number="11.1">
<h2><span class="header-section-number">11.1</span> Hierarchical models with Stan<a href="ch-complexstan.html#sec-hierstan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the following sections, we will revisit and expand on some of the examples from chapter <a href="ch-hierarchical.html#ch-hierarchical">5</a>.</p>
<div id="varying-intercept-model-with-stan" class="section level3 hasAnchor" number="11.1.1">
<h3><span class="header-section-number">11.1.1</span> Varying intercept model with Stan<a href="ch-complexstan.html#varying-intercept-model-with-stan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Recall that in section <a href="ch-hierarchical.html#sec-N400hierarchical">5.2</a>, we fit models to investigate the effect of cloze probability on  EEG averages in the  N400 spatiotemporal time window. For our first model, we’ll make the (implausible) assumption that only the average signal varies across subjects, but all subjects share the same effect of  cloze probability. This means that the  likelihood incorporates the assumption that the intercept, <span class="math inline">\(\alpha\)</span>, is adjusted with the term <span class="math inline">\(u_i\)</span> for each subject.</p>
<p><span class="math display">\[\begin{equation}
  signal_n \sim \mathit{Normal}(\alpha + u_{subj[n]} + c\_cloze_n \cdot \beta,\sigma)
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
 \begin{aligned}
 \alpha &amp;\sim \mathit{Normal}(0,10)\\
 \beta  &amp;\sim \mathit{Normal}(0,10)\\
 u &amp;\sim \mathit{Normal}(0,\tau_u)\\
 \tau_{u} &amp;\sim \mathit{Normal}_+(0,20) \\
 \sigma  &amp;\sim \mathit{Normal}_+(0,50)
 \end{aligned}
 \end{equation}\]</span></p>
<p>Here <span class="math inline">\(n\)</span> represents each observation, the <span class="math inline">\(n\)</span>th row in the data frame and <span class="math inline">\(subj[n]\)</span> is the subject that corresponds to observation <span class="math inline">\(n\)</span>. We present the mathematical notation of the likelihood with  “multiple indexing” <span class="citation">(see Stan Development Team <a href="#ref-Stan2023" role="doc-biblioref">2024</a>, Chapter 19 of the User’s guide)</span>: the index of <span class="math inline">\(u\)</span> is provided by the vector <span class="math inline">\(subj\)</span>.</p>
<p>Before we discuss the Stan implementation, let’s see what the vector <span class="math inline">\(\mu\)</span>, the  location of the normal likelihood, looks like. There are 2863 observations; that means that <span class="math inline">\(\boldsymbol{\mu}=\langle \mu_1,\mu_2, \ldots, \mu_{2863}\rangle\)</span>. We have 37 subjects which means that <span class="math inline">\(\boldsymbol{u}=\langle u_1,u_2, \ldots, u_{37} \rangle\)</span>. The following equation shows that the use of multiple indexing allows us to have a vector of adjustments with only 37 different elements, with a total length of 2863. In the equation below, the multiplication operator <span class="math inline">\(\circ\)</span> is the  Hadamard or elementwise product <span class="citation">(Fieller <a href="#ref-fieller" role="doc-biblioref">2016</a>)</span>: when we write <span class="math inline">\(X\circ B\)</span>, both <span class="math inline">\(X\)</span> and <span class="math inline">\(B\)</span> have the same dimensions <span class="math inline">\(m\times n\)</span>, and each cell in location <span class="math inline">\([i,j]\)</span> (where <span class="math inline">\(i=1,\dots,m\)</span>, and <span class="math inline">\(j=1,\dots,n\)</span>) in <span class="math inline">\(X\)</span> and <span class="math inline">\(B\)</span> are multiplied to give a matrix that also has dimensions <span class="math inline">\(m\times n\)</span>.<a href="#fn41" class="footnote-ref" id="fnref41"><sup>41</sup></a></p>
<p><span class="math display" id="eq:broadcasted">\[\begin{equation}
 \begin{aligned}
    \boldsymbol{\mu} &amp;=
    \begin{bmatrix}
        \mu_1 \\
        \mu_2 \\
        \ldots \\
        \mu_{101} \\
        \mu_{102} \\
        \ldots \\
        \mu_{215} \\
        \mu_{216} \\
        \mu_{217} \\
        \ldots \\
        \mu_{1000} \\
        \ldots \\
        \mu_{2863}
    \end{bmatrix}
=
    \begin{bmatrix}
        \alpha \\
        \alpha \\
        \ldots \\
        \alpha \\
        \alpha \\
        \ldots \\
        \alpha \\
        \alpha \\
        \alpha \\
        \ldots \\
        \alpha \\
        \ldots \\
        \alpha
    \end{bmatrix}
+
\begin{bmatrix}
u_{subj[1]} \\
u_{subj[2]} \\
\ldots \\
u_{subj[101]} \\
u_{subj[102]} \\
\ldots \\
u_{subj[215]} \\
u_{subj[216]} \\
u_{subj[217]} \\
\ldots \\
u_{subj[1000]} \\
\ldots \\
u_{subj[2863]}
\end{bmatrix}
+
\begin{bmatrix}
ccloze_1 \\
ccloze_2 \\
\ldots \\
ccloze_{101} \\
ccloze_{102} \\
\ldots \\
ccloze_{215} \\
ccloze_{216} \\
ccloze_{217} \\
\ldots \\
ccloze_{1000} \\
\ldots \\
ccloze_{2863}
\end{bmatrix}
\circ
\begin{bmatrix}
\beta \\
\beta \\
\ldots \\
\beta \\
\beta \\
\ldots \\
\beta \\
\beta \\
\beta \\
\ldots \\
\beta \\
\ldots \\
\beta
\end{bmatrix} \\
&amp; =
\begin{bmatrix}
\alpha \\
\alpha \\
\ldots \\
\alpha \\
\alpha \\
\ldots \\
\alpha \\
\alpha \\
\alpha \\
\ldots \\
\alpha \\
\ldots \\
\alpha
\end{bmatrix}
+
\begin{bmatrix}
u_{1} \\
u_{1} \\
\ldots \\
u_{2} \\
u_{2} \\
\ldots \\
u_{3} \\
u_{3} \\
u_{3} \\
\ldots \\
u_{13} \\
\ldots \\
u_{37 }
\end{bmatrix}
+
\begin{bmatrix}
{-0.476} \\
{-0.446} \\
\ldots \\
{-0.206} \\
{0.494} \\
\ldots \\
{-0.136} \\
{0.094} \\
{0.294} \\
\ldots \\
{0.524} \\
\ldots \\
{0.494 }
\end{bmatrix}
\circ
\begin{bmatrix}
\beta \\
\beta \\
\ldots \\
\beta \\
\beta \\
\ldots \\
\beta \\
\beta \\
\beta \\
\ldots \\
\beta \\
\ldots \\
\beta
\end{bmatrix}
\end{aligned}
\tag{11.1}
\end{equation}\]</span></p>
<p>In this model, each subject has their own intercept adjustment <span class="math inline">\(u_i\)</span>, with <span class="math inline">\(i\)</span> indexing the subjects. If <span class="math inline">\(u_i\)</span> is positive, the subject has a more positive EEG signal than the average over all the subjects; if <span class="math inline">\(u_i\)</span> is negative, then the subject has a more negative EEG signal than the average; and if <span class="math inline">\(u_i\)</span> is <span class="math inline">\(0\)</span>, then the subject has the same EEG signal as the average. As we discussed in section <a href="ch-hierarchical.html#sec-uncorrelated">5.2.3</a>, since we are estimating <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(u\)</span> at the same time and we assume that the average of the <span class="math inline">\(u\)</span>’s is <span class="math inline">\(0\)</span> (since it is assumed to be normally distributed with a mean of zero and there is an intercept to absorb any non-zero mean), whatever the subjects have in common “goes” to <span class="math inline">\(\alpha\)</span>, and <span class="math inline">\(u\)</span> only “absorbs” the differences between subjects through the variance component <span class="math inline">\(\tau_u\)</span>.</p>
<p>This model is implemented in the file <code>hierarchical1.stan</code>, available in the <code>bcogsci</code> package:</p>
<pre class="stan fold-show"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] signal;
  int&lt;lower = 1&gt; N_subj;
  vector[N] c_cloze;
  // The following line defines an array of integers;
  array[N] int&lt;lower = 1, upper = N_subj&gt; subj;
}
parameters {
  real&lt;lower = 0&gt; sigma;
  real&lt;lower = 0&gt;  tau_u;
  real alpha;
  real beta;
  vector[N_subj] u;
}
model {
  target += normal_lpdf(alpha| 0, 10);
  target += normal_lpdf(beta | 0, 10);
  target += normal_lpdf(sigma | 0, 50)  -
    normal_lccdf(0 | 0, 50);
  target += normal_lpdf(tau_u | 0, 20)  -
    normal_lccdf(0 | 0, 20);
  target += normal_lpdf(u | 0, tau_u);
  target += normal_lpdf(signal | alpha + u[subj] +
                        c_cloze * beta, sigma);
}
</code></pre>
<p>In the Stan code above, we use</p>
<p><code>array [N] int&lt;lower = 1, upper = N_subj&gt; subj;</code></p>
<p>to define a one-dimensional  <em>array</em> of <code>N</code> elements that contains integers (bounded between 1 and <code>N_subj</code>). As explained in Box <a href="ch-introstan.html#thm:stancontainers">10.4</a>, the difference between vectors and one-dimensional arrays is that vectors can only contain real numbers and can be used with matrix algebra functions, and arrays can contain any type but can’t be used with matrix algebra functions. We use <code>normal_lpdf</code> rather than <code>normal_glm_lpdf</code> since at the moment there is no efficient likelihood implementation of hierarchical generalized linear models.</p>
<p>The following code centers the predictor cloze and stores the data required by the Stan model in a list. Because we are using <code>subj</code> as a vector of indices, we need to be careful to have integers starting from <code>1</code> and ending in <code>N_subj</code> without skipping any number (but the order of the subject ids won’t matter).<a href="#fn42" class="footnote-ref" id="fnref42"><sup>42</sup></a></p>
<div class="sourceCode" id="cb694"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb694-1"><a href="ch-complexstan.html#cb694-1" aria-hidden="true"></a><span class="kw">data</span>(<span class="st">&quot;df_eeg&quot;</span>)</span>
<span id="cb694-2"><a href="ch-complexstan.html#cb694-2" aria-hidden="true"></a>df_eeg &lt;-<span class="st"> </span>df_eeg <span class="op">%&gt;%</span></span>
<span id="cb694-3"><a href="ch-complexstan.html#cb694-3" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">c_cloze =</span> cloze <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(cloze))</span>
<span id="cb694-4"><a href="ch-complexstan.html#cb694-4" aria-hidden="true"></a>ls_eeg &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> <span class="kw">nrow</span>(df_eeg),</span>
<span id="cb694-5"><a href="ch-complexstan.html#cb694-5" aria-hidden="true"></a>               <span class="dt">signal =</span> df_eeg<span class="op">$</span>n400,</span>
<span id="cb694-6"><a href="ch-complexstan.html#cb694-6" aria-hidden="true"></a>               <span class="dt">c_cloze =</span> df_eeg<span class="op">$</span>c_cloze,</span>
<span id="cb694-7"><a href="ch-complexstan.html#cb694-7" aria-hidden="true"></a>               <span class="dt">subj =</span> df_eeg<span class="op">$</span>subj,</span>
<span id="cb694-8"><a href="ch-complexstan.html#cb694-8" aria-hidden="true"></a>               <span class="dt">N_subj =</span> <span class="kw">max</span>(df_eeg<span class="op">$</span>subj))</span></code></pre></div>
<p>Fit the model:</p>
<div class="sourceCode" id="cb695"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb695-1"><a href="ch-complexstan.html#cb695-1" aria-hidden="true"></a>hierarchical1 &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb695-2"><a href="ch-complexstan.html#cb695-2" aria-hidden="true"></a>                             <span class="st">&quot;hierarchical1.stan&quot;</span>,</span>
<span id="cb695-3"><a href="ch-complexstan.html#cb695-3" aria-hidden="true"></a>                             <span class="dt">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb695-4"><a href="ch-complexstan.html#cb695-4" aria-hidden="true"></a>fit_eeg1 &lt;-<span class="st"> </span><span class="kw">stan</span>(hierarchical1, <span class="dt">data =</span> ls_eeg)</span></code></pre></div>
<p>Summary of the model:</p>
<div class="sourceCode" id="cb696"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb696-1"><a href="ch-complexstan.html#cb696-1" aria-hidden="true"></a><span class="kw">print</span>(fit_eeg1, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau_u&quot;</span>))</span></code></pre></div>
<pre><code>##        mean  2.5% 97.5% n_eff Rhat
## alpha  3.64  2.75  4.47  1730    1
## beta   2.32  1.25  3.34  5402    1
## sigma 11.64 11.33 11.95  5332    1
## tau_u  2.17  1.54  2.99  2801    1</code></pre>
</div>
<div id="sec-uncorrstan" class="section level3 hasAnchor" number="11.1.2">
<h3><span class="header-section-number">11.1.2</span> Uncorrelated  varying intercept and slopes model with Stan<a href="ch-complexstan.html#sec-uncorrstan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the following model, we relax the strong assumption that every subject will be affected equally by the manipulation. For ease of exposition, we start by assuming that (as we did in section <a href="ch-hierarchical.html#sec-uncorrelated">5.2.3</a>) the adjustments for the intercept and slope are not correlated.</p>
<p><span class="math display" id="eq:uncorrstanlik">\[\begin{equation}
  signal_n \sim \mathit{Normal}(\alpha + u_{subj[n],1} + c\_cloze_n \cdot (\beta+ u_{subj[n],2}),\sigma)
\tag{11.2}
\end{equation}\]</span></p>
<p><span class="math display" id="eq:uncorrstanpriors">\[\begin{equation}
 \begin{aligned}
 \alpha &amp;\sim \mathit{Normal}(0,10)\\
 \beta  &amp;\sim \mathit{Normal}(0,10)\\
 u_1 &amp;\sim \mathit{Normal}(0,\tau_{u_1})\\
 u_2 &amp;\sim \mathit{Normal}(0,\tau_{u_2})\\
 \tau_{u_1} &amp;\sim \mathit{Normal}_+(0,20) \\
 \tau_{u_2} &amp;\sim \mathit{Normal}_+(0,20) \\
 \sigma  &amp;\sim \mathit{Normal}_+(0,50)
 \end{aligned}
\tag{11.3}
\end{equation}\]</span></p>
<p>We implement this in Stan in <code>hierarchical2.stan</code>:</p>
<pre class="stan fold-show"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] signal;
  int&lt;lower = 1&gt; N_subj;
  vector[N] c_cloze;
  array[N] int&lt;lower = 1, upper = N_subj&gt; subj;
}
parameters {
  real&lt;lower = 0&gt; sigma;
  vector&lt;lower = 0&gt;[2]  tau_u;
  real alpha;
  real beta;
  matrix[N_subj, 2] u;
}
model {
  target += normal_lpdf(alpha| 0, 10);
  target += normal_lpdf(beta | 0, 10);
  target += normal_lpdf(sigma | 0, 50)  -
    normal_lccdf(0 | 0, 50);
  target += normal_lpdf(tau_u[1] | 0, 20)  -
    normal_lccdf(0 | 0, 20);
  target += normal_lpdf(tau_u[2] | 0, 20)  -
    normal_lccdf(0 | 0, 20);
  target += normal_lpdf(u[, 1]| 0, tau_u[1]);
  target += normal_lpdf(u[, 2]| 0, tau_u[2]);
  target += normal_lpdf(signal | alpha + u[subj, 1] +
                        c_cloze .* (beta + u[subj, 2]), sigma);
}
</code></pre>
<p>In the previous model, we assign the same prior distribution to both <code>tau_u[1]</code> and <code>tau_u[2]</code>, and thus in principle we could have written the two statements in one (we multiply by 2 because there are two log-PDFs that need to be corrected for the truncation):</p>
<pre><code>  target += normal_lpdf(tau_u | 0, 20)  - 
    2 * normal_lccdf(0 | 0, 20);</code></pre>
<p>Fit the model as follows:</p>
<div class="sourceCode" id="cb700"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb700-1"><a href="ch-complexstan.html#cb700-1" aria-hidden="true"></a>hierarchical2 &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb700-2"><a href="ch-complexstan.html#cb700-2" aria-hidden="true"></a>                             <span class="st">&quot;hierarchical2.stan&quot;</span>,</span>
<span id="cb700-3"><a href="ch-complexstan.html#cb700-3" aria-hidden="true"></a>                             <span class="dt">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb700-4"><a href="ch-complexstan.html#cb700-4" aria-hidden="true"></a>fit_eeg2 &lt;-<span class="st"> </span><span class="kw">stan</span>(hierarchical2, <span class="dt">data =</span> ls_eeg)</span></code></pre></div>
<pre><code> ## Warning: Bulk Effective Samples Size (ESS) is too low,
 ## indicating posterior means and medians may be unreliable.
 ## Running the chains for more iterations may help. See
 ## https://mc-stan.org/misc/warnings.html#bulk-ess </code></pre>
<pre><code> ## Warning: Tail Effective Samples Size (ESS) is too low,
 ## indicating posterior variances and tail quantiles may be
 ## unreliable. Running the chains for more iterations may
 ## help. See
 ## https://mc-stan.org/misc/warnings.html#tail-ess </code></pre>
<p>We see that there are warnings. As we increase the complexity and the number of parameters, the sampler has a harder time exploring the parameter space.</p>
<p>Show the summary of the model below:</p>
<div class="sourceCode" id="cb703"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb703-1"><a href="ch-complexstan.html#cb703-1" aria-hidden="true"></a><span class="kw">print</span>(fit_eeg2, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<pre><code>##           mean  2.5% 97.5% n_eff Rhat
## alpha     3.65  2.81  4.42  1793 1.00
## beta      2.34  1.14  3.59  3755 1.00
## tau_u[1]  2.18  1.53  2.98  2351 1.00
## tau_u[2]  1.89  0.52  3.55   250 1.02
## sigma    11.61 11.31 11.93  6461 1.00</code></pre>
<p>We see that <code>tau_u[2]</code> has a low number of effective samples (<code>n_eff</code>).</p>
<p>The traceplots are displayed in Figure <a href="ch-complexstan.html#fig:traceploteeg2">11.1</a>:</p>

<div class="sourceCode" id="cb705"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb705-1"><a href="ch-complexstan.html#cb705-1" aria-hidden="true"></a><span class="kw">traceplot</span>(fit_eeg2, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:traceploteeg2"></span>
<img src="bookdown_files/figure-html/traceploteeg2-1.svg" alt="Traceplots of alpha, beta, tau_u, and sigma from the model fit_eeg2." width="672" />
<p class="caption">
FIGURE 11.1: Traceplots of <code>alpha</code>, <code>beta</code>, <code>tau_u</code>, and <code>sigma</code> from the model <code>fit_eeg2</code>.
</p>
</div>
<p>Figure <a href="ch-complexstan.html#fig:traceploteeg2">11.1</a> shows that the chains of the parameter <code>tau_u[2]</code> are not mixing properly. This parameter is especially problematic because there are not enough data from each subject to estimate this parameter accurately, its estimated mean is quite small (in comparison with <code>sigma</code>), it’s bounded by zero, and there is a dependency between this parameter and <code>u[, 2]</code>. This makes the  exploration by the sampler quite hard.</p>
<p>Pairs plots can be useful to uncover pathologies in the sampling, since we can visualize dependencies between samples, which are in general problematic.<a href="#fn43" class="footnote-ref" id="fnref43"><sup>43</sup></a> The following code creates a  pair plot where we see the samples of <code>tau_u[2]</code> against some of the adjustments to the slope <code>u</code>; see Figure <a href="ch-complexstan.html#fig:pairsfunnel">11.2</a>.</p>

<div class="sourceCode" id="cb706"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb706-1"><a href="ch-complexstan.html#cb706-1" aria-hidden="true"></a><span class="kw">pairs</span>(fit_eeg2, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;tau_u[2]&quot;</span>, <span class="st">&quot;u[1,2]&quot;</span>, <span class="st">&quot;u[2,2]&quot;</span>, <span class="st">&quot;u[3,2]&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:pairsfunnel"></span>
<img src="bookdown_files/figure-html/pairsfunnel-1.svg" alt="Pair plots showing a relatively strong dependency (funnel-shaped clouds of samples) between the samples of \(\tau_2\) and some of the by-subject adjustments to the slope." width="672" />
<p class="caption">
FIGURE 11.2: Pair plots showing a relatively strong dependency  (funnel-shaped clouds of samples) between the samples of <span class="math inline">\(\tau_2\)</span> and some of the by-subject adjustments to the slope.
</p>
</div>
<p>Compare with <code>tau_u[1]</code> plotted against the by-subject adjustments to the intercept. In Figure <a href="ch-complexstan.html#fig:pairsblobs">11.3</a>, instead of funnels we see blobs, indicating no strong dependency between the parameters.</p>

<div class="sourceCode" id="cb707"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb707-1"><a href="ch-complexstan.html#cb707-1" aria-hidden="true"></a><span class="kw">pairs</span>(fit_eeg2, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;tau_u[1]&quot;</span>, <span class="st">&quot;u[1,1]&quot;</span>, <span class="st">&quot;u[2,1]&quot;</span>, <span class="st">&quot;u[3,1]&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:pairsblobs"></span>
<img src="bookdown_files/figure-html/pairsblobs-1.svg" alt="Pair plots showing no strong dependency (blob-shaped clouds of samples) between the samples of \(\tau_1\) and some of the by-subject adjustments to the intercept." width="672" />
<p class="caption">
FIGURE 11.3: Pair plots showing no strong dependency (blob-shaped clouds of samples) between the samples of <span class="math inline">\(\tau_1\)</span> and some of the by-subject adjustments to the intercept.
</p>
</div>
<p>In contrast to Figure <a href="ch-complexstan.html#fig:pairsblobs">11.3</a>, Figure <a href="ch-complexstan.html#fig:pairsfunnel">11.2</a> shows a relatively strong dependency between the samples of some of the parameters of the model, in particular <span class="math inline">\(\tau_2\)</span> and the samples of <span class="math inline">\(u_{i,2}\)</span>: If we see small values in the samples for <span class="math inline">\(\tau_2\)</span>, then the values for the samples of <span class="math inline">\(u_i\)</span> are very close to zero (and they are larger if values of samples of <span class="math inline">\(\tau_2\)</span> are larger). This strong dependency is hindering the exploration of the sampler leading to the warnings we saw in Stan. However, the problem that the sampler faces is, in fact, more serious than what our initial plots show. Stan samples in an  <em>unconstrained</em> space where all the parameters can range from minus infinity to plus infinity, and then transforms back the parameters to the constrained space that we specified where, for example, a standard deviation parameter is restricted to be positive. This means that Stan is actually sampling from a transformed parameter equivalent to <code>log(tau_u[2])</code> rather than from <code>tau_u[2]</code>. We can use  <code>mcmc_pairs</code> to see the actual funnel; see Figure <a href="ch-complexstan.html#fig:scatterpairs">11.4</a>.</p>

<div class="sourceCode" id="cb708"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb708-1"><a href="ch-complexstan.html#cb708-1" aria-hidden="true"></a><span class="kw">mcmc_pairs</span>(<span class="kw">as.array</span>(fit_eeg2),</span>
<span id="cb708-2"><a href="ch-complexstan.html#cb708-2" aria-hidden="true"></a>           <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;tau_u[2]&quot;</span>, <span class="st">&quot;u[1,2]&quot;</span>),</span>
<span id="cb708-3"><a href="ch-complexstan.html#cb708-3" aria-hidden="true"></a>           <span class="dt">transform =</span> <span class="kw">list</span>(<span class="st">`</span><span class="dt">tau_u[2]</span><span class="st">`</span> =<span class="st"> &quot;log&quot;</span>)) </span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:scatterpairs"></span>
<img src="bookdown_files/figure-html/scatterpairs-1.svg" alt="Pair plots showing a strong dependency (funnel-shaped clouds of samples) between the samples of \(\tau_2\) and one of the by-subject adjustments to the intercept (\(u_{1,2}\))." width="672" />
<p class="caption">
FIGURE 11.4: Pair plots showing a strong dependency (funnel-shaped clouds of samples) between the samples of <span class="math inline">\(\tau_2\)</span> and one of the by-subject adjustments to the intercept (<span class="math inline">\(u_{1,2}\)</span>).
</p>
</div>
<p>At the neck of the funnel, <code>tau_u[2]</code> is close to zero (and <code>log(tau_u[2])</code> is a negative number) and thus the adjustment <code>u</code> is constrained to be near <span class="math inline">\(0\)</span>. This is a problem because a  step size that’s optimized to work well in the broad part of the funnel will fail to work appropriately in the  neck of the funnel and vice versa; see also  Neal’s funnel <span class="citation">(Neal <a href="#ref-neal2003" role="doc-biblioref">2003</a>)</span> and the  optimization chapter of <span class="citation">Stan Development Team (<a href="#ref-Stan2023" role="doc-biblioref">2024</a>)</span> (section 26.7 of the User’s guide).
There are two options: We might just remove the by-subject varying slope since it’s not giving us much information anyway, or we can alleviate this problem by  reparameterizing the model. In general, this sort of thing is the trickiest and probably most annoying part of modeling. A model can be theoretically and mathematically sound, but still  fail to converge. The best advice to solve this type of problem is to start small with simulated data where we know the true values of the parameters, and increase the complexity of the models gradually. Although in this example the problem was clearly in the parameterization of <code>tau_u[2]</code>, in many cases the biggest hurdle is to identify where the problem lies. Fortunately, the issue with <code>tau_u[2]</code> is a common problem which is easy to solve by using a  non-centered parameterization <span class="citation">(Betancourt and Girolami <a href="#ref-betancourt2013hamiltonian" role="doc-biblioref">2015</a>; Papaspiliopoulos, Roberts, and Sköld <a href="#ref-papaspiliopoulos2007" role="doc-biblioref">2007</a>)</span>. The Box <a href="ch-complexstan.html#thm:noncenterparam">11.1</a> explains the specific reparameterization we use for the improved version of our Stan code.</p>
<div class="extra">
<div class="theorem">
<p><span id="thm:noncenterparam" class="theorem"><strong>Box 11.1  </strong></span><strong>A simple non-centered parameterization</strong></p>
</div>
<p>The sampler can explore the parameter space more easily if its step size is appropriate for all the parameters. This is achieved when there are no strong dependencies between parameters. We want to assume the following.</p>
<p><span class="math display">\[\begin{equation}
\mathbf{u}_{2} \sim \mathit{Normal}(0, \tau_{u_2})
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\mathbf{u}_{2}\)</span> is the column vector of <span class="math inline">\(u_{i,2}\)</span>’s. The index <span class="math inline">\(i\)</span> refers to the subject id.</p>
<p>We can transform a vector <span class="math inline">\(v\)</span> into <span class="math inline">\(z\)</span>-scores as follows.</p>
<p><span class="math display">\[\begin{equation}
\mathbf{z}_{v} =\frac{\mathbf{v} - mean(\mathbf{v})}{SD(\mathbf{v})}
\end{equation}\]</span></p>
<p>Transforming the parameter <span class="math inline">\(u_2\)</span> into <span class="math inline">\(z\)</span>-scores amounts to centering it, so we can call this a  centered parameterization.</p>
<p><span class="math display">\[\begin{equation}
\mathbf{z}_{u_2} =\frac{\mathbf{u}_{2} - 0}{\tau_{u_2}}
\end{equation}\]</span></p>
<p>where
<span class="math display">\[\begin{equation}
\mathbf{z}_{u_2} \sim \mathit{Normal}(0, 1)
\end{equation}\]</span></p>
<p>Now <span class="math inline">\(\mathbf{z}_{u_2}\)</span> is easier to sample because it doesn’t depend on other parameters (in particular, it is no longer conditional on <span class="math inline">\(\tau\)</span>) and its scale is <span class="math inline">\(1\)</span>. Once we have sampled this centered parameter, we can derive the actual parameter we care about by carrying out the inverse operation, which is called a  non-centered parameterization:</p>
<p><span class="math display">\[\begin{equation}
\mathbf{u}_{2} = \mathbf{z}_{u_2} \cdot \tau_{u_2}
\end{equation}\]</span></p>
<p>A question that might be raised here is whether using a non-centered parameterization is always a good idea. <span class="citation">Betancourt and Girolami (<a href="#ref-betancourt2013hamiltonian" role="doc-biblioref">2015</a>)</span> point out that the extremeness of the dependency depends on the amount of data, and the efficacy of the parameterization depends on the strength of the data (on how informative the data is). When there is enough data, this parameterization is unnecessary and it may be more efficient to use the centered parameterization. However, cases where there is enough data to render this parameterization useless might also be cases where the partial pooling of the hierarchical models may not be needed in the first place. Although data from conventional lab experiments in psychology, psycholinguistics, and related areas seem to benefit from the non-centered parameterization, the jury is still out for larger data sets with thousands of subjects from crowdsourcing websites.</p>
</div>
<p>From a mathematical point of view, the following model is equivalent to the one described in Equations <a href="ch-complexstan.html#eq:uncorrstanlik">(11.2)</a> and <a href="ch-complexstan.html#eq:uncorrstanpriors">(11.3)</a>. However, as discussed previously, the computational implementation of the “new” model is more efficient. The following model includes the reparameterization of both adjustments <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span>, although the reparameterization of <span class="math inline">\(u_1\)</span> is not strictly necessary (we didn’t see any problems in the traceplots), it won’t hurt either and the Stan code will be simpler.</p>
<p><span class="math display" id="eq:uncorrstanlik2">\[\begin{equation}
  signal_n \sim \mathit{Normal}(\alpha + u_{subj[n],1} + c\_cloze_n \cdot (\beta+ u_{subj[n],2}),\sigma)
\tag{11.4}
\end{equation}\]</span></p>
<p><span class="math display" id="eq:uncorrstanpriors2">\[\begin{equation}
 \begin{aligned}
 \alpha &amp;\sim \mathit{Normal}(0,10)\\
 \beta  &amp;\sim \mathit{Normal}(0,10)\\
 z_{u_1} &amp;\sim \mathit{Normal}(0, 1)\\
 z_{u_2} &amp;\sim \mathit{Normal}(0, 1)\\
 \tau_{u_1} &amp;\sim \mathit{Normal}_+(0,20) \\
 \tau_{u_2} &amp;\sim \mathit{Normal}_+(0,20) \\
 \sigma  &amp;\sim \mathit{Normal}_+(0,50)\\
 u_1 &amp;= z_{u_1} \cdot \tau_{u_1}\\
 u_2 &amp;= z_{u_2} \cdot \tau_{u_2}
 \end{aligned}
\tag{11.5}
\end{equation}\]</span></p>
<p>The following Stan code (<code>hierarchical3.stan</code>) uses the previous parameterization, and introduces some new Stan functions:  <code>to_vector()</code> converts a matrix into a long column vector (in column-major order, that is, concatenating the columns from left to right); and  <code>std_normal_lpdf()</code> implements the log PDF of a  standard normal distribution, a normal distribution with location 0 and scale 1. This function is just a more efficient version of <code>normal_lpdf(... | 0, 1)</code>. We also introduce a new optional  block called  <code>transformed parameters</code>. With each iteration of the sampler, the values of the parameters (i.e., <code>alpha</code>, <code>beta</code>, <code>sigma</code>, and <code>z</code>) are available at the <code>transformed parameters</code> block, and we can derive new auxiliary variables based on them. In this case, we use <code>z_u</code> and <code>tau_u</code> to obtain <code>u</code>, that then becomes available in the <code>model</code> block. Notice that both the model block and R (when we output the stan object) can access both parameters and transformed parameters.</p>
<pre class="stan fold-show"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] signal;
  int&lt;lower = 1&gt; N_subj;
  vector[N] c_cloze;
  array[N] int&lt;lower = 1, upper = N_subj&gt; subj;
}
parameters {
  real&lt;lower = 0&gt; sigma;
  vector&lt;lower = 0&gt;[2]  tau_u;
  real alpha;
  real beta;
  matrix[N_subj, 2] z_u;
}
transformed parameters {
  matrix[N_subj, 2] u;
  u[, 1] = z_u[, 1] * tau_u[1];
  u[, 2] = z_u[, 2] * tau_u[2];
 }
model {
  target += normal_lpdf(alpha| 0, 10);
  target += normal_lpdf(beta | 0, 10);
  target += normal_lpdf(sigma | 0, 50)  -
    normal_lccdf(0 | 0, 50);
  target += normal_lpdf(tau_u[1] | 0, 20)  -
    normal_lccdf(0 | 0, 20);
 target += normal_lpdf(tau_u[2] | 0, 20)  -
    normal_lccdf(0 | 0, 20);
  target += std_normal_lpdf(to_vector(z_u));
  target += normal_lpdf(signal | alpha + u[subj, 1] +
                        c_cloze .* (beta + u[subj, 2]), sigma);
}
</code></pre>
<p>By reparameterizing the model we can also optimize it more, we can convert the matrix <code>z_u</code> into a long column vector allowing us to use a single call of <code>std_normal_lpdf</code>. Fit the model named <code>hierarchical3.stan</code>.</p>
<div class="sourceCode" id="cb710"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb710-1"><a href="ch-complexstan.html#cb710-1" aria-hidden="true"></a>hierarchical3 &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb710-2"><a href="ch-complexstan.html#cb710-2" aria-hidden="true"></a>                             <span class="st">&quot;hierarchical3.stan&quot;</span>,</span>
<span id="cb710-3"><a href="ch-complexstan.html#cb710-3" aria-hidden="true"></a>                             <span class="dt">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb710-4"><a href="ch-complexstan.html#cb710-4" aria-hidden="true"></a>fit_eeg3 &lt;-<span class="st"> </span><span class="kw">stan</span>(hierarchical3, <span class="dt">data =</span> ls_eeg) </span></code></pre></div>
<p>Verify that the model worked as expected by printing its summary and traceplots; see Figure <a href="ch-complexstan.html#fig:traceploteeg3">11.5</a>.</p>

<div class="sourceCode" id="cb711"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb711-1"><a href="ch-complexstan.html#cb711-1" aria-hidden="true"></a><span class="kw">print</span>(fit_eeg3, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<pre><code>##           mean  2.5% 97.5% n_eff Rhat
## alpha     3.63  2.79  4.48  1558    1
## beta      2.32  1.10  3.56  3250    1
## tau_u[1]  2.16  1.52  2.96  1303    1
## tau_u[2]  1.70  0.12  3.48  1110    1
## sigma    11.62 11.32 11.92  6091    1</code></pre>
<div class="sourceCode" id="cb713"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb713-1"><a href="ch-complexstan.html#cb713-1" aria-hidden="true"></a><span class="kw">traceplot</span>(fit_eeg3, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:traceploteeg3"></span>
<img src="bookdown_files/figure-html/traceploteeg3-1.svg" alt="Traceplots of alpha, beta, tau_u, and sigma from the model fit_eeg3." width="672" />
<p class="caption">
FIGURE 11.5: Traceplots of <code>alpha</code>, <code>beta</code>, <code>tau_u</code>, and <code>sigma</code> from the model <code>fit_eeg3</code>.
</p>
</div>
<p>Although the samples of <code>tau_u[2]</code> are still conditioned by the adjustments for the slope, <code>u[,2]</code>, these latter parameters are not the ones explored by the model, the auxiliary parameters, <code>z_u</code>, are the relevant ones for the sampler. The plots in Figures <a href="ch-complexstan.html#fig:pairstauu">11.6</a> and <a href="ch-complexstan.html#fig:pairstauz">11.7</a> show that although samples from <code>log(tau_u[2])</code> and <code>u[1,2]</code> depend on each other, samples from
<code>log(tau_u[2])</code> and <code>z_u[1,2]</code> do not.</p>

<div class="sourceCode" id="cb714"><pre class="sourceCode r fold-hide"><code class="sourceCode r"><span id="cb714-1"><a href="ch-complexstan.html#cb714-1" aria-hidden="true"></a></span>
<span id="cb714-2"><a href="ch-complexstan.html#cb714-2" aria-hidden="true"></a><span class="kw">mcmc_pairs</span>(<span class="kw">as.array</span>(fit_eeg3),</span>
<span id="cb714-3"><a href="ch-complexstan.html#cb714-3" aria-hidden="true"></a>           <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;tau_u[2]&quot;</span>, <span class="st">&quot;u[1,2]&quot;</span>),</span>
<span id="cb714-4"><a href="ch-complexstan.html#cb714-4" aria-hidden="true"></a>           <span class="dt">transform =</span> <span class="kw">list</span>(<span class="st">`</span><span class="dt">tau_u[2]</span><span class="st">`</span> =<span class="st"> &quot;log&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:pairstauu"></span>
<img src="bookdown_files/figure-html/pairstauu-1.svg" alt="Pair plots showing a clear dependency (funnel-shaped clouds of samples) between the samples of \(\tau_2\) and some of the by-subject adjustments to the slope." width="672" />
<p class="caption">
FIGURE 11.6: Pair plots showing a clear dependency (funnel-shaped clouds of samples) between the samples of <span class="math inline">\(\tau_2\)</span> and some of the by-subject adjustments to the slope.
</p>
</div>

<div class="sourceCode" id="cb715"><pre class="sourceCode r fold-hide"><code class="sourceCode r"><span id="cb715-1"><a href="ch-complexstan.html#cb715-1" aria-hidden="true"></a></span>
<span id="cb715-2"><a href="ch-complexstan.html#cb715-2" aria-hidden="true"></a><span class="kw">mcmc_pairs</span>(<span class="kw">as.array</span>(fit_eeg3),</span>
<span id="cb715-3"><a href="ch-complexstan.html#cb715-3" aria-hidden="true"></a>           <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;tau_u[2]&quot;</span>, <span class="st">&quot;z_u[1,2]&quot;</span>),</span>
<span id="cb715-4"><a href="ch-complexstan.html#cb715-4" aria-hidden="true"></a>           <span class="dt">transform =</span> <span class="kw">list</span>(<span class="st">`</span><span class="dt">tau_u[2]</span><span class="st">`</span> =<span class="st"> &quot;log&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:pairstauz"></span>
<img src="bookdown_files/figure-html/pairstauz-1.svg" alt="Pair plots showing no clear dependency between the samples of \(\tau_2\) and some of the by-subject auxiliary parameters (z_u) used to build the adjustments to the slope." width="672" />
<p class="caption">
FIGURE 11.7: Pair plots showing no clear dependency between the samples of <span class="math inline">\(\tau_2\)</span> and some of the by-subject auxiliary parameters (<code>z_u</code>) used to build the adjustments to the slope.
</p>
</div>
</div>
<div id="sec-corrstan" class="section level3 hasAnchor" number="11.1.3">
<h3><span class="header-section-number">11.1.3</span>  Correlated varying intercept varying slopes model<a href="ch-complexstan.html#sec-corrstan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For the model with correlated varying intercepts and slopes, the likelihood remains identical to the model without a correlation between group-level intercepts and slopes. Priors and hyperpriors change to reflect the potential correlation between by-subject adjustments to intercepts and slopes:</p>
<p><span class="math display">\[\begin{equation}
  signal_n \sim \mathit{Normal}(\alpha + u_{subj[n],1} + c\_cloze_n \cdot  (\beta + u_{subj[n],2}),\sigma)
\end{equation}\]</span></p>
<p>The correlation is indicated in the priors on the adjustments for vector of by-subject intercepts <span class="math inline">\(u_{1}\)</span> and the vector of by-subject slopes <span class="math inline">\(u_{2}\)</span>.</p>
<ul>
<li>Priors:
<span class="math display">\[\begin{equation}
 \begin{aligned}
 \alpha &amp; \sim \mathit{Normal}(0,10) \\
 \beta  &amp; \sim \mathit{Normal}(0,10) \\
  \sigma  &amp;\sim \mathit{Normal}_+(0,50)\\
  {\begin{pmatrix}
  u_{i,1} \\
  u_{i,2}
  \end{pmatrix}}
 &amp;\sim {\mathcal {N}}
  \left(
 {\begin{pmatrix}
  0\\
  0
 \end{pmatrix}}
 ,\boldsymbol{\Sigma_u} \right)
 \end{aligned}
 \end{equation}\]</span></li>
</ul>
<p>where <span class="math inline">\(i\)</span> ranges from <span class="math inline">\(1\)</span> to <span class="math inline">\(N_{subj}\)</span></p>
<p><span class="math display">\[\begin{equation}
\boldsymbol{\Sigma_u} = 
{\begin{pmatrix} 
\tau_{u_1}^2 &amp; \rho_u \tau_{u_1} \tau_{u_2} \\ 
\rho_u \tau_{u_1} \tau_{u_2} &amp; \tau_{u_2}^2
\end{pmatrix}}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
\tau_{u_1} &amp;\sim \mathit{Normal}_+(0,20)\\
\tau_{u_2} &amp;\sim \mathit{Normal}_+(0,20)\\
\mathbf{R_u} &amp; =
\begin{bmatrix}
1 &amp; \rho_u \\
\rho_u &amp; 1
\end{bmatrix} \sim \mathit{LKJcorr}(2)
\end{aligned}
\end{equation}\]</span></p>
<p>As a first attempt, we write this model following the mathematical notation as closely as possible. We’ll see that this will be problematic in terms of efficient sampling and convergence. In this Stan model (<code>hierarchical_corr.stan</code>), we use some new functions and types:</p>
<ul>
<li> <code>corr_matrix[n] R;</code> defines a (square) matrix of <span class="math inline">\(n\)</span> rows and <span class="math inline">\(n\)</span> columns called <span class="math inline">\(R\)</span>, symmetrical around a diagonal of ones.</li>
<li> <code>rep_row_vector(X, n)</code> creates a row vector with <span class="math inline">\(n\)</span> columns filled with <span class="math inline">\(X\)</span>.</li>
<li> <code>quad_form_diag(R, v)</code> creates a  <em>quadratic form</em> using the column vector <span class="math inline">\(v\)</span> as a diagonal matrix (a matrix with all zeros except for its diagonal), this function corresponds in Stan to: <code>diag_matrix(v) * R * diag_matrix(v)</code> and in R to <code>diag(v) %*% R %*% diag(v)</code>. This
computes a  variance-covariance matrix from the vector of  standard deviations, <span class="math inline">\(v\)</span>, and the  correlation matrix, <span class="math inline">\(R\)</span> (recall the generation of multivariate data in section <a href="ch-intro.html#sec-generatebivariatedata">1.6.3</a>).</li>
</ul>
<pre class="stan fold-show"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] signal;
  int&lt;lower = 1&gt; N_subj;
  vector[N] c_cloze;
  array[N] int&lt;lower = 1, upper = N_subj&gt; subj;
}
parameters {
  real&lt;lower = 0&gt; sigma;
  vector&lt;lower = 0&gt;[2]  tau_u;
  real alpha;
  real beta;
  matrix[N_subj, 2] u;
  corr_matrix[2] R_u;
}
model {
  target += normal_lpdf(alpha| 0,10);
  target += normal_lpdf(beta | 0,10);
  target += normal_lpdf(sigma | 0, 50)  -
    normal_lccdf(0 | 0, 50);
  target += normal_lpdf(tau_u | 0, 20)  -
    2 * normal_lccdf(0 | 0, 20);
  target += lkj_corr_lpdf(R_u | 2);
  for(i in 1:N_subj)
    target +=  multi_normal_lpdf(u[i,] |
                                 rep_row_vector(0, 2),
                                 quad_form_diag(R_u, tau_u));
  target += normal_lpdf(signal | alpha + u[subj, 1] +
                        c_cloze .* (beta + u[subj, 2]), sigma);
}</code></pre>
<p>Problematic aspects of the first model presented in section <a href="ch-complexstan.html#sec-uncorrstan">11.1.2</a> (before the reparameterization), that is, dependencies between parameters, are also present here. Fit the model as follows:</p>
<div class="sourceCode" id="cb717"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb717-1"><a href="ch-complexstan.html#cb717-1" aria-hidden="true"></a>hierarchical_corr &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb717-2"><a href="ch-complexstan.html#cb717-2" aria-hidden="true"></a>                                 <span class="st">&quot;hierarchical_corr.stan&quot;</span>,</span>
<span id="cb717-3"><a href="ch-complexstan.html#cb717-3" aria-hidden="true"></a>                                 <span class="dt">package =</span> <span class="st">&quot;bcogsci&quot;</span>) </span>
<span id="cb717-4"><a href="ch-complexstan.html#cb717-4" aria-hidden="true"></a>fit_eeg_corr &lt;-<span class="st"> </span><span class="kw">stan</span>(hierarchical_corr, <span class="dt">data =</span> ls_eeg)</span></code></pre></div>
<pre><code> ## Warning: There were 1 divergent transitions after
 ## warmup. See
 ## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
 ## to find out why this is a problem and how to eliminate
 ## them. </code></pre>
<pre><code> ## Warning: There were 3 chains where the estimated
 ## Bayesian Fraction of Missing Information was low. See
 ## https://mc-stan.org/misc/warnings.html#bfmi-low </code></pre>
<pre><code> ## Warning: Examine the pairs() plot to diagnose sampling
 ## problems </code></pre>
<pre><code> ## Warning: The largest R-hat is NA, indicating chains have
 ## not mixed. Running the chains for more iterations may
 ## help. See https://mc-stan.org/misc/warnings.html#r-hat </code></pre>
<pre><code> ## Warning: Bulk Effective Samples Size (ESS) is too low,
 ## indicating posterior means and medians may be unreliable.
 ## Running the chains for more iterations may help. See
 ## https://mc-stan.org/misc/warnings.html#bulk-ess </code></pre>
<pre><code> ## Warning: Tail Effective Samples Size (ESS) is too low,
 ## indicating posterior variances and tail quantiles may be
 ## unreliable. Running the chains for more iterations may
 ## help. See
 ## https://mc-stan.org/misc/warnings.html#tail-ess </code></pre>
<p>As we expected, there are warnings and bad  mixing of the chains for <code>tau_u[2]</code>; see also the traceplots in Figure <a href="ch-complexstan.html#fig:traceploteegcorr">11.8</a>.</p>
<div class="sourceCode" id="cb724"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb724-1"><a href="ch-complexstan.html#cb724-1" aria-hidden="true"></a><span class="kw">print</span>(fit_eeg_corr, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<pre><code>##           mean  2.5% 97.5% n_eff Rhat
## alpha     3.63  2.83  4.46  1362  1.0
## beta      2.33  1.11  3.57  4343  1.0
## tau_u[1]  2.19  1.53  2.99  2168  1.0
## tau_u[2]  1.56  0.17  3.43    39  1.1
## sigma    11.62 11.31 11.93  5458  1.0</code></pre>

<div class="sourceCode" id="cb726"><pre class="sourceCode r fold-hide"><code class="sourceCode r"><span id="cb726-1"><a href="ch-complexstan.html#cb726-1" aria-hidden="true"></a></span>
<span id="cb726-2"><a href="ch-complexstan.html#cb726-2" aria-hidden="true"></a><span class="kw">traceplot</span>(fit_eeg_corr, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;sigma&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:traceploteegcorr"></span>
<img src="bookdown_files/figure-html/traceploteegcorr-1.svg" alt="Traceplots of alpha, beta, tau_u, and sigma from the model fit_eeg_corr." width="672" />
<p class="caption">
FIGURE 11.8: Traceplots of <code>alpha</code>, <code>beta</code>, <code>tau_u</code>, and <code>sigma</code> from the model <code>fit_eeg_corr</code>.
</p>
</div>
<p>The problem (which can also be discovered in a pairs plot) is the same one that we saw before: There is a strong dependency between <code>tau_u[2]</code> (in fact, <code>log(tau_u[2])</code>, which is the parameter dimension that the sampler considers) and <code>u</code>, creating a funnel.</p>
<p>The solution to this problem is the reparameterization of this model. The reparameterization for this type of model requires us to use  Cholesky factorization <span class="citation">(Fieller <a href="#ref-fieller" role="doc-biblioref">2016</a>)</span>. The mathematics and the intuition behind this parameterization are explained in Box <a href="ch-complexstan.html#thm:cholesky">11.2</a>.</p>
<div class="extra">
<div class="theorem">
<p><span id="thm:cholesky" class="theorem"><strong>Box 11.2  </strong></span><strong>Cholesky factorization</strong></p>
</div>
<p>First, some definitions that we will need below. A matrix is square if the number of rows and columns is identical. A  square matrix <span class="math inline">\(A\)</span> is symmetric if <span class="math inline">\(A^T = A\)</span>, i.e., if transposing the matrix gives the matrix back. Suppose that <span class="math inline">\(A\)</span> is a known matrix with real numbers. If <span class="math inline">\(\boldsymbol{x}\)</span> is a vector of variables with length <span class="math inline">\(p\)</span> (a <span class="math inline">\(p\times 1\)</span> matrix), then <span class="math inline">\(x^T A x\)</span> is called a  quadratic form in <span class="math inline">\(x\)</span> (<span class="math inline">\(x^T A x\)</span> will be a scalar, <span class="math inline">\(1\times 1\)</span>). If <span class="math inline">\(x^TAx&gt;0\)</span> for all <span class="math inline">\(x\)</span>, then <span class="math inline">\(A\)</span> is a  positive definite matrix. If <span class="math inline">\(x^TAx\geq 0\)</span> for all <span class="math inline">\(x\neq0\)</span>, then <span class="math inline">\(A\)</span> is positive semi-definite.</p>
<p>We encountered correlation matrices first in section <a href="ch-intro.html#sec-generatebivariatedata">1.6.3</a>. A correlation matrix is always symmetric, has ones along the diagonal, and real values ranging between <span class="math inline">\(-1\)</span> and <span class="math inline">\(1\)</span> on the off-diagonals. Given a  correlation matrix <span class="math inline">\(\mathbf{R_u}\)</span>, we can decompose it into a  lower triangular matrix <span class="math inline">\(\mathbf{L_u}\)</span> such that <span class="math inline">\(\mathbf{L_u}\mathbf{L_u}^T=\mathbf{R_u}\)</span>. The matrix <span class="math inline">\(\mathbf{L_u}\)</span> is called the  Cholesky factor of <span class="math inline">\(\mathbf{R_u}\)</span>. Intuitively, you can think of <span class="math inline">\(\mathbf{L_u}\)</span> as the matrix equivalent of the square root of <span class="math inline">\(\mathbf{R_u}\)</span>. More details on the Cholesky factorization can be found in <span class="citation">Gentle (<a href="#ref-Gentle" role="doc-biblioref">2007</a>)</span>.</p>
<p><span class="math display">\[\begin{equation}
\mathbf{L_u}  =
{\begin{pmatrix} 
L_{11} &amp; 0 \\ 
L_{21}  &amp; L_{22}
\end{pmatrix}}
\end{equation}\]</span></p>
<p>For a model without a correlation between adjustments for the intercept and slope, we assumed that adjustments <span class="math inline">\(u_{1}\)</span> and <span class="math inline">\(u_{2}\)</span> were generated by two independent normal distributions. But now we want to allow the possibility that the adjustments can have a non-zero correlation. We can use the Cholesky factorization to generate  correlated random variables in the following way.</p>
<ol style="list-style-type: decimal">
<li>Generate uncorrelated vectors, <span class="math inline">\(z_{u_1}\)</span> and <span class="math inline">\(z_{u_2}\)</span>, for each vector of
adjustments <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span>, as sampled from <span class="math inline">\(\mathit{Normal}(0,1)\)</span>:</li>
</ol>
<p><span class="math display">\[z_{u_1} \sim \mathit{Normal}(0,1)\]</span>
<span class="math display">\[z_{u_2} \sim \mathit{Normal}(0,1)\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li>By multiplying the Cholesky factor with the <span class="math inline">\(z\)</span>’s, generate a matrix that contains two row vectors of correlated variables (with standard deviation <span class="math inline">\(1\)</span>).</li>
</ol>
<p><span class="math display">\[
  \mathbf{L_u}\cdot \mathbf{z_u}  =
  {\begin{pmatrix} 
  L_{11} &amp; 0 \\ 
  L_{21}  &amp; L_{22}
  \end{pmatrix}}
  {\begin{pmatrix}
  z_{u_{1,subj=1}} &amp; z_{u_{1,subj=2}} &amp; ... &amp; z_{u_{1,subj=N_{subj}}} \\
  z_{u_{2,subj=1}} &amp; z_{u_{2,subj=2}} &amp; ... &amp; z_{u_{2,subj=N_{subj}}}
  \end{pmatrix}}
  \]</span></p>
<p><span class="math display">\[
  =
  {\begin{pmatrix}
  L_{11} \cdot z_{u_{1,1}} + 0 \cdot z_{u_{2,1}} &amp;   ... &amp; L_{11} \cdot z_{u_{1,N_{subj}}} + 0 \cdot z_{u_{2,1}}  \\
  L_{21} \cdot z_{u_{1,1}} + L_{22} \cdot z_{u_{2,1}} &amp; ... &amp; L_{11} \cdot z_{u_{1,N_{subj}}} + L_{22} \cdot z_{u_{2,N_{subj}}}
  \end{pmatrix}}
  \]</span></p>
<p>A very informal explanation of why this works is that we are making the
variable that corresponds to the slope to be a function of a scaled version of
the intercept.</p>
<ol start="3" style="list-style-type: decimal">
<li>The last step is to scale the previous matrix to the desired standard deviation. We define the diagonalized matrix  <span class="math inline">\(diag\_matrix(\tau_u)\)</span> as before:</li>
</ol>
<p><span class="math display">\[
  {\begin{pmatrix} 
  \tau_{u_1} &amp; 0 \\ 
  0  &amp; \tau_{u_2}
  \end{pmatrix}}
  \]</span></p>
<p>Then pre-multiply it by the correlated variables with standard deviation 1 from before:</p>
<p><span class="math display">\[\mathbf{u} = diag\_matrix(\tau_u) \cdot \mathbf{L_u}\cdot \mathbf{z_u} = \]</span></p>
<p><span class="math display">\[ 
  {\begin{pmatrix} 
  \tau_{u_1} &amp; 0 \\ 
  0  &amp; \tau_{u_2}
  \end{pmatrix}}
  {\begin{pmatrix}
  L_{11} \cdot z_{u_{1,1}}  &amp; ...  \\
  L_{21} \cdot z_{u_{1,1}} + L_{22} \cdot z_{u_{2,1}} &amp; ... 
  \end{pmatrix}}
  \]</span></p>
<p><span class="math display">\[ 
  {\begin{pmatrix}
  \tau_{u_1} \cdot L_{11} \cdot z_{u_{1,1}}  &amp; \tau_{u_1} \cdot L_{11} \cdot  z_{u_{1,2}} &amp; ...  \\
  \tau_{u_2} \cdot (L_{21} \cdot z_{u_{1,1}} + L_{22} \cdot z_{u_{2,1}}) &amp; \tau_{u_2} \cdot (L_{21} \cdot  z_{u_{1,2}} + L_{22} \cdot z_{u_{2,2}}) &amp; ... 
  \end{pmatrix}}
  \]</span></p>
<p>It might be helpful to see how one would implement this in R:</p>
<p>Let’s assume a correlation of <span class="math inline">\(0.8\)</span>.</p>
<div class="sourceCode" id="cb727"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb727-1"><a href="ch-complexstan.html#cb727-1" aria-hidden="true"></a>rho_u &lt;-<span class="st"> </span><span class="fl">0.8</span></span>
<span id="cb727-2"><a href="ch-complexstan.html#cb727-2" aria-hidden="true"></a><span class="co"># Correlation matrix</span></span>
<span id="cb727-3"><a href="ch-complexstan.html#cb727-3" aria-hidden="true"></a>(R_u &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, rho_u, rho_u, <span class="dv">1</span>), <span class="dt">ncol =</span> <span class="dv">2</span>))</span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]  1.0  0.8
## [2,]  0.8  1.0</code></pre>
<div class="sourceCode" id="cb729"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb729-1"><a href="ch-complexstan.html#cb729-1" aria-hidden="true"></a><span class="co"># Cholesky factor:</span></span>
<span id="cb729-2"><a href="ch-complexstan.html#cb729-2" aria-hidden="true"></a><span class="co"># (Transpose it so that it looks the same as in Stan)</span></span>
<span id="cb729-3"><a href="ch-complexstan.html#cb729-3" aria-hidden="true"></a>(L_u &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">chol</span>(R_u)))</span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]  1.0  0.0
## [2,]  0.8  0.6</code></pre>
<div class="sourceCode" id="cb731"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb731-1"><a href="ch-complexstan.html#cb731-1" aria-hidden="true"></a><span class="co"># Verify that we recover R_u,</span></span>
<span id="cb731-2"><a href="ch-complexstan.html#cb731-2" aria-hidden="true"></a><span class="co"># Recall that %*% indicates matrix multiplication</span></span>
<span id="cb731-3"><a href="ch-complexstan.html#cb731-3" aria-hidden="true"></a>L_u <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(L_u)</span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]  1.0  0.8
## [2,]  0.8  1.0</code></pre>
<ol style="list-style-type: decimal">
<li>Generate uncorrelated z from a standard normal distribution assuming only 10 subjects.</li>
</ol>
<div class="sourceCode" id="cb733"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb733-1"><a href="ch-complexstan.html#cb733-1" aria-hidden="true"></a>N_subj &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb733-2"><a href="ch-complexstan.html#cb733-2" aria-hidden="true"></a>(z_u1 &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N_subj, <span class="dv">0</span>, <span class="dv">1</span>))</span></code></pre></div>
<pre><code>##  [1]  1.0966  1.4457 -1.9251  0.4128  1.5934 -0.4140 -0.2122
##  [8] -0.0365  0.3650  0.6652</code></pre>
<div class="sourceCode" id="cb735"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb735-1"><a href="ch-complexstan.html#cb735-1" aria-hidden="true"></a>(z_u2 &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N_subj, <span class="dv">0</span>, <span class="dv">1</span>))</span></code></pre></div>
<pre><code>##  [1]  1.31782 -0.09549  0.19628  2.48800  0.43110  0.18875
##  [7] -1.34224  0.00286 -0.22133 -0.01105</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Create matrix of correlated parameters.</li>
</ol>
<p>First, create a matrix with the uncorrelated parameters:</p>
<div class="sourceCode" id="cb737"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb737-1"><a href="ch-complexstan.html#cb737-1" aria-hidden="true"></a><span class="co"># matrix z_u</span></span>
<span id="cb737-2"><a href="ch-complexstan.html#cb737-2" aria-hidden="true"></a>(z_u &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(z_u1, z_u2), <span class="dt">ncol =</span> N_subj, <span class="dt">byrow =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>##      [,1]    [,2]   [,3]  [,4]  [,5]   [,6]   [,7]     [,8]
## [1,] 1.10  1.4457 -1.925 0.413 1.593 -0.414 -0.212 -0.03654
## [2,] 1.32 -0.0955  0.196 2.488 0.431  0.189 -1.342  0.00286
##        [,9]  [,10]
## [1,]  0.365  0.665
## [2,] -0.221 -0.011</code></pre>
<p>Then, generate correlated parameters by pre-multiplying the <span class="math inline">\(\mathbf{z}_u\)</span> matrix with <span class="math inline">\(\mathbf{L}_u\)</span>.</p>
<div class="sourceCode" id="cb739"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb739-1"><a href="ch-complexstan.html#cb739-1" aria-hidden="true"></a>L_u <span class="op">%*%</span><span class="st"> </span>z_u</span></code></pre></div>
<pre><code>##      [,1] [,2]  [,3]  [,4] [,5]   [,6]   [,7]    [,8]  [,9] [,10]
## [1,] 1.10 1.45 -1.93 0.413 1.59 -0.414 -0.212 -0.0365 0.365 0.665
## [2,] 1.67 1.10 -1.42 1.823 1.53 -0.218 -0.975 -0.0275 0.159 0.526</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Use the following diagonal matrix to scale the z_u.</li>
</ol>
<div class="sourceCode" id="cb741"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb741-1"><a href="ch-complexstan.html#cb741-1" aria-hidden="true"></a>tau_u1 &lt;-<span class="st"> </span><span class="fl">0.2</span></span>
<span id="cb741-2"><a href="ch-complexstan.html#cb741-2" aria-hidden="true"></a>tau_u2 &lt;-<span class="st"> </span><span class="fl">0.01</span></span>
<span id="cb741-3"><a href="ch-complexstan.html#cb741-3" aria-hidden="true"></a>(diag_matrix_tau &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(tau_u1,  tau_u2)))</span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]  0.2 0.00
## [2,]  0.0 0.01</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Finally, generate the adjustments for each subject u:</li>
</ol>
<div class="sourceCode" id="cb743"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb743-1"><a href="ch-complexstan.html#cb743-1" aria-hidden="true"></a>(u &lt;-<span class="st"> </span>diag_matrix_tau <span class="op">%*%</span><span class="st"> </span>L_u <span class="op">%*%</span><span class="st"> </span>z_u)</span></code></pre></div>
<pre><code>##        [,1]  [,2]    [,3]   [,4]   [,5]     [,6]     [,7]
## [1,] 0.2193 0.289 -0.3850 0.0826 0.3187 -0.08280 -0.04243
## [2,] 0.0167 0.011 -0.0142 0.0182 0.0153 -0.00218 -0.00975
##           [,8]    [,9]   [,10]
## [1,] -0.007307 0.07300 0.13303
## [2,] -0.000275 0.00159 0.00526</code></pre>
<div class="sourceCode" id="cb745"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb745-1"><a href="ch-complexstan.html#cb745-1" aria-hidden="true"></a><span class="co"># The rows are correlated, approximately 0.8</span></span>
<span id="cb745-2"><a href="ch-complexstan.html#cb745-2" aria-hidden="true"></a><span class="kw">cor</span>(u[<span class="dv">1</span>, ], u[<span class="dv">2</span>, ])</span></code></pre></div>
<pre><code>## [1] 0.848</code></pre>
<div class="sourceCode" id="cb747"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb747-1"><a href="ch-complexstan.html#cb747-1" aria-hidden="true"></a><span class="co"># The variance components can be recovered as well:</span></span>
<span id="cb747-2"><a href="ch-complexstan.html#cb747-2" aria-hidden="true"></a><span class="kw">sd</span>(u[<span class="dv">1</span>, ])</span></code></pre></div>
<pre><code>## [1] 0.207</code></pre>
<div class="sourceCode" id="cb749"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb749-1"><a href="ch-complexstan.html#cb749-1" aria-hidden="true"></a><span class="kw">sd</span>(u[<span class="dv">2</span>, ])</span></code></pre></div>
<pre><code>## [1] 0.0112</code></pre>
</div>
<p>The reparameterization of the model, which allows for a correlation between adjustments for the intercepts and slopes, in <code>hierarchical_corr2.stan</code> is shown below.
The code implements the following new types and functions:</p>
<ul>
<li> <code>cholesky_factor_corr[2] L_u</code>, which defines <code>L_u</code> as a lower triangular (<span class="math inline">\(2 \times 2\)</span>)
matrix which has to be the  Cholesky factor of a correlation.</li>
<li> <code>diag_pre_multiply(tau_u,L_u)</code> which makes a diagonal matrix out of
the vector <code>tau_u</code> and multiplies it by <code>L_u</code>.</li>
<li> <code>to_vector(z_u)</code> makes a long vector out the matrix <code>z_u</code>.</li>
<li> <code>lkj_corr_cholesky_lpdf(L_u | 2)</code> is the Cholesky factor associated with the  LKJ correlation distribution. It implies that <code>lkj_corr_lpdf(L_u * L_u'| 2)</code>. The symbol <code>'</code> indicates transposition (in R, this is the function <code>t()</code>).</li>
</ul>
<pre class="stan fold-show"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] signal;
  int&lt;lower = 1&gt; N_subj;
  vector[N] c_cloze;
  array[N] int&lt;lower = 1, upper = N_subj&gt; subj;
}
parameters {
  real&lt;lower = 0&gt; sigma;
  vector&lt;lower = 0&gt;[2]  tau_u;
  real alpha;
  real beta;
  matrix[2, N_subj] z_u;
  cholesky_factor_corr[2] L_u;
}
transformed parameters {
  matrix[N_subj, 2] u;
  u = (diag_pre_multiply(tau_u, L_u) * z_u)&#39;;
}
model {
  target += normal_lpdf(alpha| 0,10);
  target += normal_lpdf(beta | 0,10);
  target += normal_lpdf(sigma | 0, 50)  -
    normal_lccdf(0 | 0, 50);
  target += normal_lpdf(tau_u | 0, 20)  -
    2 * normal_lccdf(0 | 0, 20);
  target += lkj_corr_cholesky_lpdf(L_u | 2);
  target += std_normal_lpdf(to_vector(z_u));
  target += normal_lpdf(signal | alpha + u[subj, 1] +
                        c_cloze .* (beta + u[subj, 2]), sigma);
}
generated quantities {
  matrix[2, 2] R_u = (L_u * L_u&#39;);
  real rho_u = R_u[1, 2];
  vector[N_subj] effect_by_subj = beta + u[ , 2];
}</code></pre>
<p>In this Stan model, we also defined an <code>effect_by_subject</code> in the generated quantities. This would allow us to plot or to summarize by-subject effects of cloze probability.</p>
<p>One can recover the  correlation parameter by adding in the <code>generated quantities</code> section code to extract one element of the <span class="math inline">\(2 \times 2\)</span> correlation matrix. The correlation matrix is recovered with <code>L_u * L_u'</code>, and then <code>[1, 2]</code> extracts the element in the first row and second column (recall that the diagonal is filled with ones).</p>
<p>Fit the new model:</p>
<div class="sourceCode" id="cb752"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb752-1"><a href="ch-complexstan.html#cb752-1" aria-hidden="true"></a>hierarchical_corr2 &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb752-2"><a href="ch-complexstan.html#cb752-2" aria-hidden="true"></a>                                  <span class="st">&quot;hierarchical_corr2.stan&quot;</span>,</span>
<span id="cb752-3"><a href="ch-complexstan.html#cb752-3" aria-hidden="true"></a>                                  <span class="dt">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb752-4"><a href="ch-complexstan.html#cb752-4" aria-hidden="true"></a>fit_eeg_corr2 &lt;-<span class="st"> </span><span class="kw">stan</span>(hierarchical_corr2, <span class="dt">data =</span> ls_eeg)</span></code></pre></div>
<p>The Cholesky matrix has some elements which are always zero or one, and thus the variance within and between chains (and therefore Rhat) are not defined. However, the rest of the parameters of the model have an appropriate number of effective sample size (more than 10% of the total number of post-warmup samples), Rhats are close to one, and the chains are mixing well; see also the traceplots in Figure <a href="ch-complexstan.html#fig:traceploteegcorr2">11.9</a>.</p>
<div class="sourceCode" id="cb753"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb753-1"><a href="ch-complexstan.html#cb753-1" aria-hidden="true"></a><span class="kw">print</span>(fit_eeg_corr2,</span>
<span id="cb753-2"><a href="ch-complexstan.html#cb753-2" aria-hidden="true"></a>      <span class="dt">pars =</span></span>
<span id="cb753-3"><a href="ch-complexstan.html#cb753-3" aria-hidden="true"></a>        <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;rho_u&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;L_u&quot;</span>)) </span></code></pre></div>
<pre><code>##           mean  2.5% 97.5% n_eff Rhat
## alpha     3.66  2.81  4.50  1345 1.01
## beta      2.33  1.14  3.56  3488 1.00
## tau_u[1]  2.18  1.55  3.00  1529 1.00
## tau_u[2]  1.61  0.09  3.53   863 1.01
## rho_u     0.16 -0.58  0.77  2681 1.00
## sigma    11.62 11.31 11.93  5136 1.00
## L_u[1,1]  1.00  1.00  1.00   NaN  NaN
## L_u[1,2]  0.00  0.00  0.00   NaN  NaN
## L_u[2,1]  0.16 -0.58  0.77  2681 1.00
## L_u[2,2]  0.92  0.62  1.00  1937 1.00</code></pre>

<div class="sourceCode" id="cb755"><pre class="sourceCode r fold-hide"><code class="sourceCode r"><span id="cb755-1"><a href="ch-complexstan.html#cb755-1" aria-hidden="true"></a></span>
<span id="cb755-2"><a href="ch-complexstan.html#cb755-2" aria-hidden="true"></a><span class="kw">traceplot</span>(fit_eeg_corr2,</span>
<span id="cb755-3"><a href="ch-complexstan.html#cb755-3" aria-hidden="true"></a>          <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;L_u[2,1]&quot;</span>, <span class="st">&quot;L_u[2,2]&quot;</span>, <span class="st">&quot;sigma&quot;</span>)) </span>
<span id="cb755-4"><a href="ch-complexstan.html#cb755-4" aria-hidden="true"></a><span class="st">`</span><span class="dt">## Warning: Line is too long.</span><span class="st">`</span></span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:traceploteegcorr2"></span>
<img src="bookdown_files/figure-html/traceploteegcorr2-1.svg" alt="Traceplots of alpha, beta, tau_u, L_u, and sigma from the model fit_eeg_corr." width="672" />
<p class="caption">
FIGURE 11.9: Traceplots of <code>alpha</code>, <code>beta</code>, <code>tau_u</code>, <code>L_u</code>, and <code>sigma</code> from the model <code>fit_eeg_corr</code>.
</p>
</div>
<p>Is there a correlation between the by-subject intercept and slope?</p>
<p>Let’s visualize some of the posteriors with the following code (see Figure <a href="ch-complexstan.html#fig:posteegcorr2">11.10</a>):</p>

<div class="sourceCode" id="cb756"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb756-1"><a href="ch-complexstan.html#cb756-1" aria-hidden="true"></a><span class="kw">mcmc_hist</span>(<span class="kw">as.data.frame</span>(fit_eeg_corr2),</span>
<span id="cb756-2"><a href="ch-complexstan.html#cb756-2" aria-hidden="true"></a>          <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;rho_u&quot;</span>)) </span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:posteegcorr2"></span>
<img src="bookdown_files/figure-html/posteegcorr2-1.svg" alt="Histograms of the samples of the posteriors of beta and rho_u from the model fit_eeg_corr2." width="672" />
<p class="caption">
FIGURE 11.10: Histograms of the samples of the posteriors of <code>beta</code> and <code>rho_u</code> from the model <code>fit_eeg_corr2</code>.
</p>
</div>
<p>Figure <a href="ch-complexstan.html#fig:posteegcorr2">11.10</a> shows that the posterior distribution is widely spread out between <span class="math inline">\(-1\)</span> and <span class="math inline">\(+1\)</span>. One can’t really learn from these data whether the by-subject intercepts and slopes are correlated. The broad spread of the posterior indicates that we don’t have enough data to estimate this parameter with high enough precision: the posterior is basically just reflecting the prior specification (the LKJcorr prior with parameter <span class="math inline">\(\eta = 2\)</span>).</p>
</div>
<div id="sec-crosscorrstan" class="section level3 hasAnchor" number="11.1.4">
<h3><span class="header-section-number">11.1.4</span> By-subject and by-items correlated varying intercept varying slopes model<a href="ch-complexstan.html#sec-crosscorrstan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We extend the previous model by adding by-items intercepts and slopes, and priors and hyperpriors that reflect the potential correlation between  by-items adjustments to intercepts and slopes:</p>
<p><span class="math display">\[\begin{multline}
  signal_n \sim \mathit{Normal}(\alpha + u_{subj[n], 1} + w_{item[n], 1} + \\
  c\_cloze_n \cdot  (\beta + u_{subj[n],2} + w_{item[n], 2}),\sigma)
\end{multline}\]</span></p>
<p>The correlation is indicated in the priors on the adjustments for the vectors representing the varying intercepts <span class="math inline">\(u_{1}\)</span> and varying slopes <span class="math inline">\(u_{2}\)</span> for subjects, and the varying intercepts <span class="math inline">\(w_{1}\)</span> and varying slopes <span class="math inline">\(w_{2}\)</span> for items.</p>
<ul>
<li>Priors:
<span class="math display">\[\begin{equation}
 \begin{aligned} 
 \alpha &amp; \sim \mathit{Normal}(0,10) \\
 \beta  &amp; \sim \mathit{Normal}(0,10) \\
  \sigma  &amp;\sim \mathit{Normal}_+(0, 50)\\
    {\begin{pmatrix}
  u_{i,1} \\
  u_{i,2}
  \end{pmatrix}}
 &amp;\sim {\mathcal {N}}
  \left(
 {\begin{pmatrix} 
  0\\
  0
 \end{pmatrix}}
 ,\boldsymbol{\Sigma_u} \right) \\
   {\begin{pmatrix}
  w_{i,1} \\
  w_{i,2}
  \end{pmatrix}}
 &amp;\sim {\mathcal {N}}
  \left(
 {\begin{pmatrix} 
  0\\
  0
 \end{pmatrix}}
 ,\boldsymbol{\Sigma_w} \right)
 \end{aligned}
 \end{equation}\]</span></li>
</ul>
<p><span class="math display">\[\begin{equation}
\boldsymbol{\Sigma_u} = 
{\begin{pmatrix} 
\tau_{u_1}^2 &amp; \rho_u \tau_{u_1} \tau_{u_2} \\ 
\rho_u \tau_{u_1} \tau_{u_1} &amp; \tau_{u_2}^2
\end{pmatrix}}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\boldsymbol{\Sigma_w} = 
{\begin{pmatrix} 
\tau_{w_1}^2 &amp; \rho_w \tau_{w_1} \tau_{w_2} \\ 
\rho_w \tau_{w_1} \tau_{w_1} &amp; \tau_{w_2}^2
\end{pmatrix}}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
\tau_{u_1} &amp;\sim \mathit{Normal}_+(0,20)\\
\tau_{u_2} &amp;\sim \mathit{Normal}_+(0,20)\\
\mathbf{R_u} &amp; =
\begin{bmatrix}
1 &amp; \rho_u \\
\rho_u &amp; 1
\end{bmatrix} \sim \mathit{LKJcorr}(2) 
\end{aligned}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
\tau_{w_1} &amp;\sim \mathit{Normal}_+(0,20)\\
\tau_{w_2} &amp;\sim \mathit{Normal}_+(0,20)\\
\mathbf{R_w} &amp; =
\begin{bmatrix}
1 &amp; \rho_w \\
\rho_w &amp; 1
\end{bmatrix} \sim \mathit{LKJcorr}(2) 
\end{aligned}
\end{equation}\]</span></p>
<p>The translation to Stan (<code>hierarchical_corr_by.stan</code>) looks as follows:</p>
<pre class="stan fold-show"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] signal;
  int&lt;lower = 1&gt; N_subj;
  int&lt;lower = 1&gt; N_item;
  vector[N] c_cloze;
  array[N] int&lt;lower = 1, upper = N_subj&gt; subj;
  array[N] int&lt;lower = 1, upper = N_item&gt; item;
}
parameters {
  real&lt;lower = 0&gt; sigma;
  vector&lt;lower = 0&gt;[2]  tau_u;
  vector&lt;lower = 0&gt;[2]  tau_w;
  real alpha;
  real beta;
  matrix[2, N_subj] z_u;
  matrix[2, N_item] z_w;
  cholesky_factor_corr[2] L_u;
  cholesky_factor_corr[2] L_w;
}
transformed parameters {
  matrix[N_subj, 2] u;
  matrix[N_item, 2] w;
  u = (diag_pre_multiply(tau_u, L_u) * z_u)&#39;;
  w = (diag_pre_multiply(tau_w, L_w) * z_w)&#39;;
}
model {
  target += normal_lpdf(alpha| 0,10);
  target += normal_lpdf(beta | 0,10);
  target += normal_lpdf(sigma | 0, 50)  -
    normal_lccdf(0 | 0, 50);
  target += normal_lpdf(tau_u | 0, 20) -
    2 * normal_lccdf(0 | 0, 20);
  target += normal_lpdf(tau_w | 0, 20) -
    2* normal_lccdf(0 | 0, 20);
  target += lkj_corr_cholesky_lpdf(L_u | 2);
  target += lkj_corr_cholesky_lpdf(L_w | 2);
  target += std_normal_lpdf(to_vector(z_u));
  target += std_normal_lpdf(to_vector(z_w));
  target += normal_lpdf(signal | alpha + u[subj, 1] + w[item, 1] +
                        c_cloze .* (beta + u[subj, 2] + w[item, 2]),
                        sigma);
}
generated quantities {
  real rho_u = (L_u * L_u&#39;)[1, 2];
  real rho_w = (L_w * L_w&#39;)[1, 2];
}</code></pre>
<p>Add item as a number to the data and store it in a list:</p>
<div class="sourceCode" id="cb758"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb758-1"><a href="ch-complexstan.html#cb758-1" aria-hidden="true"></a>df_eeg &lt;-<span class="st"> </span>df_eeg <span class="op">%&gt;%</span></span>
<span id="cb758-2"><a href="ch-complexstan.html#cb758-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">item =</span> <span class="kw">as.numeric</span>(<span class="kw">as.factor</span>(item)))</span>
<span id="cb758-3"><a href="ch-complexstan.html#cb758-3" aria-hidden="true"></a>ls_eeg &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> <span class="kw">nrow</span>(df_eeg),</span>
<span id="cb758-4"><a href="ch-complexstan.html#cb758-4" aria-hidden="true"></a>               <span class="dt">signal =</span> df_eeg<span class="op">$</span>n400,</span>
<span id="cb758-5"><a href="ch-complexstan.html#cb758-5" aria-hidden="true"></a>               <span class="dt">c_cloze =</span> df_eeg<span class="op">$</span>c_cloze,</span>
<span id="cb758-6"><a href="ch-complexstan.html#cb758-6" aria-hidden="true"></a>               <span class="dt">subj =</span> df_eeg<span class="op">$</span>subj,</span>
<span id="cb758-7"><a href="ch-complexstan.html#cb758-7" aria-hidden="true"></a>               <span class="dt">item =</span> df_eeg<span class="op">$</span>item,</span>
<span id="cb758-8"><a href="ch-complexstan.html#cb758-8" aria-hidden="true"></a>               <span class="dt">N_subj =</span> <span class="kw">max</span>(df_eeg<span class="op">$</span>subj),</span>
<span id="cb758-9"><a href="ch-complexstan.html#cb758-9" aria-hidden="true"></a>               <span class="dt">N_item =</span> <span class="kw">max</span>(df_eeg<span class="op">$</span>item))</span></code></pre></div>
<p>Fit the model:</p>
<div class="sourceCode" id="cb759"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb759-1"><a href="ch-complexstan.html#cb759-1" aria-hidden="true"></a>hierarchical_corr_by &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;stan_models&quot;</span>,</span>
<span id="cb759-2"><a href="ch-complexstan.html#cb759-2" aria-hidden="true"></a>                                    <span class="st">&quot;hierarchical_corr_by.stan&quot;</span>,</span>
<span id="cb759-3"><a href="ch-complexstan.html#cb759-3" aria-hidden="true"></a>                                    <span class="dt">package =</span> <span class="st">&quot;bcogsci&quot;</span>)</span>
<span id="cb759-4"><a href="ch-complexstan.html#cb759-4" aria-hidden="true"></a>fit_eeg_corr_by &lt;-<span class="st"> </span><span class="kw">stan</span>(hierarchical_corr_by, <span class="dt">data =</span> ls_eeg)</span></code></pre></div>
<p>Print the summary:</p>
<div class="sourceCode" id="cb760"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb760-1"><a href="ch-complexstan.html#cb760-1" aria-hidden="true"></a><span class="kw">print</span>(fit_eeg_corr_by,</span>
<span id="cb760-2"><a href="ch-complexstan.html#cb760-2" aria-hidden="true"></a>      <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau_u&quot;</span>, <span class="st">&quot;tau_w&quot;</span>, </span>
<span id="cb760-3"><a href="ch-complexstan.html#cb760-3" aria-hidden="true"></a>               <span class="st">&quot;rho_u&quot;</span>, <span class="st">&quot;rho_w&quot;</span>)) </span></code></pre></div>
<pre><code>##           mean  2.5% 97.5% n_eff Rhat
## alpha     3.66  2.74  4.54  1704 1.00
## beta      2.33  0.98  3.71  3588 1.00
## sigma    11.49 11.20 11.79  4581 1.00
## tau_u[1]  2.21  1.57  3.02  1251 1.00
## tau_u[2]  1.51  0.09  3.32  1003 1.01
## tau_w[1]  1.51  0.79  2.18  1103 1.00
## tau_w[2]  2.32  0.30  4.29  1062 1.00
## rho_u     0.13 -0.61  0.77  3794 1.00
## rho_w    -0.42 -0.89  0.31  1798 1.00</code></pre>
<p>The summary above shows that the data are far too sparse to get tight estimates of the correlation parameters <code>rho_u</code> and <code>rho_w</code>. Both posteriors are widely spread out.</p>
<p>This completes our review of hierarchical models and their implementation in Stan. The importance of coding a hierarchical model directly in Stan rather than using <code>brms</code> is that this increases the flexibility of the type of models that we can fit. In fact, we will see in chapters <a href="ch-cogmod.html#ch-cogmod">17</a>-<a href="ch-lognormalrace.html#ch-lognormalrace">20</a> that the same “machinery” can be used to have hierarchical parameters in cognitive models.</p>
</div>
</div>
<div id="summary-9" class="section level2 hasAnchor" number="11.2">
<h2><span class="header-section-number">11.2</span> Summary<a href="ch-complexstan.html#summary-9" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this chapter, we learned to fit the four standard types of hierarchical models that we encountered in earlier chapters:</p>
<ul>
<li>The by-subjects varying intercepts model.</li>
<li>The by-subjects varying intercepts and varying slopes model without any correlation.</li>
<li>The by-subjects varying intercepts and varying slopes model with correlation.</li>
<li>The hierarchical model, with a full variance covariance matrix for both subjects and items.</li>
</ul>
<p>We also learned about some important and powerful tools for making the Stan models more efficient at sampling: the non-centered parameterization and the Cholesky factorization. One important takeaway was that if data are sparse, the posteriors will just reflect the priors. We saw examples of this situation when investigating the posteriors of the correlation parameters.</p>
</div>
<div id="further-reading-8" class="section level2 hasAnchor" number="11.3">
<h2><span class="header-section-number">11.3</span> Further reading<a href="ch-complexstan.html#further-reading-8" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><span class="citation">Gelman and Hill (<a href="#ref-GelmanHill2007" role="doc-biblioref">2007</a>)</span> provides a comprehensive introduction to Bayesian hierarchical models, although that edition does not use Stan but rather WinBUGS. <span class="citation">Sorensen, Hohenstein, and Vasishth (<a href="#ref-SorensenVasishthTutorial" role="doc-biblioref">2016</a>)</span> is a short tutorial on hierarchical modeling using Stan, especially tailored for psychologists and linguists.</p>
<p>An additional example of reparameterization (kindly suggested by Martin Modrák) involves reparameterizing a varying intercept/effects model in terms of total variance and its distribution across individual components. This approach has both theoretical advantages, such as making it easier to elicit priors on total variance and its split, and practical benefits, such as allowing us to work with data sets where only a small number of subjects have repeated measurements, which might otherwise pose computational challenges. This concept is explored in more depth in <span class="citation">Hem, Fuglstad, and Riebler (<a href="#ref-hem2022" role="doc-biblioref">2022</a>)</span>. Additionally, a quick gist provided by Martin Modrák demonstrates how this reparameterization resolves divergences and increases the effective sample size in a model adapted from this chapter. You can find it at <a href="https://gist.github.com/martinmodrak/61a68f22ed954ae68abc76faeef860b6" class="uri">https://gist.github.com/martinmodrak/61a68f22ed954ae68abc76faeef860b6</a>.</p>
</div>
<div id="exercises-1" class="section level2 hasAnchor" number="11.4">
<h2><span class="header-section-number">11.4</span> Exercises<a href="ch-complexstan.html#exercises-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="exercise">
<p><span id="exr:stroop" class="exercise"><strong>Exercise 11.1  </strong></span>A log-normal model in Stan.</p>
</div>
<p>Refit the Stroop example from section <a href="ch-hierarchical.html#sec-stroop">5.3</a> in Stan (<code>df_stroop</code>).</p>
<p>Assume the following likelihood and priors:</p>
<p><span class="math display">\[\begin{equation}
  rt_n \sim \mathit{LogNormal}(\alpha + u_{subj[n],1}  + c\_cond_n \cdot  (\beta + u_{subj[n],2}), \sigma)
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
 \begin{aligned}
   \alpha &amp; \sim \mathit{Normal}(6, 1.5) \\
   \beta  &amp; \sim \mathit{Normal}(0, .1) \\
    \sigma  &amp;\sim \mathit{Normal}_+(0, 1)
 \end{aligned}
 \end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
\tau_{u_1} &amp;\sim \mathit{Normal}_+(0,1)\\
\tau_{u_2} &amp;\sim \mathit{Normal}_+(0,1)\\
\begin{bmatrix}
1 &amp; \rho_u \\
\rho_u &amp; 1
\end{bmatrix} &amp;\sim \mathit{LKJcorr}(2) 
\end{aligned}
\end{equation}\]</span></p>
<div class="exercise">
<p><span id="exr:hierarchical-logn-stan" class="exercise"><strong>Exercise 11.2  </strong></span>A by-subjects and by-items hierarchical model with a log-normal likelihood.</p>
</div>
<p>Revisit the question “Are subject relatives easier to process than object relatives?” Fit the model from the exercise <a href="ch-hierarchical.html#exr:hierarchical-logn">5.2</a> using Stan.</p>
<div class="exercise">
<p><span id="exr:strooplogis" class="exercise"><strong>Exercise 11.3  </strong></span>A hierarchical logistic regression with Stan.</p>
</div>
<p>Revisit the question “Is there a Stroop effect in accuracy?” Fit the model the exercise <a href="ch-hierarchical.html#exr:strooplogis-brms">5.6</a> using Stan.</p>
<div class="exercise">
<p><span id="exr:distr-stan" class="exercise"><strong>Exercise 11.4  </strong></span>A distributional regression model of the effect of cloze probability on the N400.</p>
</div>
<p>In section <a href="ch-hierarchical.html#sec-distrmodel">5.2.6</a>, we saw how to fit a distributional regression model. We might want to extend this approach to Stan. Fit the EEG data to a hierarchical model with by-subject and by-items varying intercept and slopes, and in addition assume that the residual standard deviation (the scale of the normal likelihood) can vary by subject.</p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
  signal_n &amp;\sim \mathit{Normal}(\alpha + u_{subj[n],1} + w_{item[n],1} + \\
  &amp; c\_cloze_n \cdot  (\beta + u_{subj[n],2}+ w_{item[n],2}), \sigma_n)\\
  \sigma_n &amp;= \exp(\alpha_{\sigma} + u_{\sigma_{subj[n]}})
\end{aligned}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
\begin{aligned}
  \alpha_\alpha &amp;\sim \mathit{Normal}(0,log(50))\\
  u_\sigma &amp;\sim \mathit{Normal}(0, \tau_{u_\sigma}) \\
  \tau_{u_\sigma} &amp;\sim \mathit{Normal}_+(0, 5)
\end{aligned}
\end{equation}\]</span></p>
<p>To fit this model, take into account that <code>sigma</code> is now a vector, and it is a transformed parameter which depends on two parameters: <code>alpha_sigma</code> and the vector with <code>N_subj</code> elements <code>u_sigma</code>. In addition, <code>u_sigma</code> depends on the hyperparameter <code>tau_u_sigma</code> (<span class="math inline">\(\tau_{u_\sigma}\)</span>). (Using the non-centered parameterization for <code>u_sigma</code> speeds up the model fit considerably).</p>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references hanging-indent">
<div id="ref-betancourt2013hamiltonian">
<p>Betancourt, Michael J., and Mark Girolami. 2015. “Hamiltonian Monte Carlo for Hierarchical Models.” <em>Current Trends in Bayesian Methodology with Applications</em> 79 (30): 2–4.</p>
</div>
<div id="ref-fieller">
<p>Fieller, Nick. 2016. <em>Basics of Matrix Algebra for Statistics with R</em>. Boca Raton, FL: CRC Press.</p>
</div>
<div id="ref-GelmanHill2007">
<p>Gelman, Andrew, and Jennifer Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press.</p>
</div>
<div id="ref-Gentle">
<p>Gentle, James E. 2007. “Matrix Algebra: Theory, Computations, and Applications in Statistics.” <em>Springer Texts in Statistics</em> 10.</p>
</div>
<div id="ref-hem2022">
<p>Hem, Ingeborg Gullikstad, Geir-Arne Fuglstad, and Andrea Riebler. 2022. “makemyprior: Intuitive Construction of Joint Priors for Variance Parameters in R.” <a href="https://arxiv.org/abs/2105.09712">https://arxiv.org/abs/2105.09712</a>.</p>
</div>
<div id="ref-neal2003">
<p>Neal, Radford M. 2003. “Slice Sampling.” <em>Annals of Statistics</em> 31 (3): 705–67. <a href="https://doi.org/10.1214/aos/1056562461">https://doi.org/10.1214/aos/1056562461</a>.</p>
</div>
<div id="ref-papaspiliopoulos2007">
<p>Papaspiliopoulos, Omiros, Gareth O. Roberts, and Martin Sköld. 2007. “A General Framework for the Parametrization of Hierarchical Models.” <em>Statistical Science</em> 22 (1): 59–73. <a href="https://doi.org/10.1214/088342307000000014">https://doi.org/10.1214/088342307000000014</a>.</p>
</div>
<div id="ref-SorensenVasishthTutorial">
<p>Sorensen, Tanner, Sven Hohenstein, and Shravan Vasishth. 2016. “Bayesian Linear Mixed Models Using Stan: A Tutorial for Psychologists, Linguists, and Cognitive Scientists.” <em>Quantitative Methods for Psychology</em> 12 (3): 175–200.</p>
</div>
<div id="ref-Stan2023">
<p>Stan Development Team. 2024. “Stan Modeling Language Users Guide and Reference Manual, Version 2.32.” <a href="https://mc-stan.org/docs/2_35/">https://mc-stan.org/docs/2_35/</a>.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="41">
<li id="fn41"><p>Whereas in <a href="ch-complexstan.html#eq:broadcasted">(11.1)</a>, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are “broadcasted” into a 2863-vector for ease of exposition, Stan uses vector-scalar arithmetic.<a href="ch-complexstan.html#fnref41" class="footnote-back">↩︎</a></p></li>
<li id="fn42"><p>It often happens that the subject ids are not in sequence in a given data frame. This can happen when, for example, one has lost some subjects due to incomplete data or for some other reason. In such situations, we can re-number the subjects sequentially as follows: type <code>as.numeric(as.factor(df_eeg$subj))</code> to transform a vector where some numbers are skipped into a vector with consecutive numbers. For example, both <code>as.numeric(as.factor(c(1, 3, 4, 7, 9)))</code> and <code>as.numeric(as.factor(paste0("subj", c(1, 3, 4, 7, 9))))</code> will give as output <code>1 2 3 4 5</code>.<a href="ch-complexstan.html#fnref42" class="footnote-back">↩︎</a></p></li>
<li id="fn43"><p>See <a href="https://mc-stan.org/misc/warnings.html" class="uri">https://mc-stan.org/misc/warnings.html</a>.<a href="ch-complexstan.html#fnref43" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch-introstan.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ch-custom.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
